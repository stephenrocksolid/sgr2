{% extends 'base.html' %}
{% load map_extras %}

{% block title %}Import Wizard - Step 3: Map Fields{% endblock %}

{% block content %}
<div class="container">
    <div class="wizard-header">
        <h1>Import Wizard</h1>
        <div class="wizard-steps">
            <div class="step completed">
                <div class="step-number">‚úì</div>
                <div class="step-label">Upload File</div>
            </div>
            <div class="step completed">
                <div class="step-number">‚úì</div>
                <div class="step-label">Configure Options</div>
            </div>
            <div class="step active">
                <div class="step-number">3</div>
                <div class="step-label">Map Fields</div>
            </div>
            <div class="step">
                <div class="step-number">4</div>
                <div class="step-label">Process</div>
            </div>
        </div>
    </div>

    <div class="wizard-content">
        <div class="mapping-section">
            <h2 style="font-size: 1.3em; margin-bottom: 4px;">Step 3: Map Your Data Fields</h2>
            <p style="font-size: 0.9em; margin-bottom: 12px; color: #666;">Map the columns in your file to the appropriate database fields.</p>
            
            <div class="file-info">
                <h3>File Information</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <label>File Name:</label>
                        <span>{{ batch.original_filename }}</span>
                    </div>
                    <div class="info-item">
                        <label>Available Headers:</label>
                        <span>{{ batch.discovered_headers|length }} columns</span>
                    </div>
                </div>
            </div>

            <div class="preview-section">
                <h3 style="cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;" onclick="toggleSection('preview-data')">
                    <span id="preview-toggle-icon" style="font-size: 1.2em;">‚ñ∂</span>
                    Data Preview
                    <small style="font-weight: normal; color: #666;">(click to expand)</small>
                </h3>
                
                <div id="preview-data" style="display: none; margin-top: 10px;">
                    <p>Your data with the discovered headers:</p>
                    
                    {% if batch.discovered_headers %}
                        <div class="table-wrap">
                            <table class="preview-table">
                                <thead>
                                    <tr>
                                        {% for header in batch.discovered_headers %}
                                            <th>{{ header }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in batch.preview_data|slice:":3" %}
                                        <tr>
                                            {% for cell in row %}
                                                <td>{{ cell|default:"‚Äî" }}</td>
                                            {% endfor %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}
                </div>
            </div>

            <form method="post" class="mapping-form">
                {% csrf_token %}
                
                <div class="mapping-sections">
                    <!-- Machines Section -->
                    <div class="mapping-section-card machine-section">
                        <div class="section-header">
                            <div class="section-title">
                                <span class="section-icon">üöú</span>
                                <h3>Machine Fields</h3>
                            </div>
                            <div class="section-progress" id="machine-progress">
                                <span class="progress-text">0 of 2 required mapped</span>
                            </div>
                        </div>
                        <p>Map fields for machine data (optional)</p>
                        <p class="required-note"><small><strong>Required if any machine field is mapped:</strong> Make<span class="required-asterisk">*</span>, Model<span class="required-asterisk">*</span></small></p>
                        
                        <div class="field-mappings">
                            {% for field in machine_form %}
                                <div class="form-group {% if 'make' in field.name and 'make' in missing_fields.machines %}field-missing{% endif %}{% if 'model' in field.name and 'model' in missing_fields.machines %}field-missing{% endif %}">
                                    <label for="{{ field.id_for_label }}">
                                        {{ field.label }}
                                        {% if 'make' in field.name or 'model' in field.name %}
                                            <span class="required-asterisk">*</span>
                                        {% endif %}
                                        {% if 'make' in field.name and 'make' in missing_fields.machines %}
                                            <span class="missing-field-indicator">‚Üê Missing!</span>
                                        {% endif %}
                                        {% if 'model' in field.name and 'model' in missing_fields.machines %}
                                            <span class="missing-field-indicator">‚Üê Missing!</span>
                                        {% endif %}
                                    </label>
                                    {{ field }}
                                    {% if field.errors %}
                                        <div class="field-error">
                                            {% for error in field.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Engine Fields (Core) -->
                    <div class="mapping-section-card engine-section">
                        <div class="section-header">
                            <div class="section-title">
                                <span class="section-icon">‚öôÔ∏è</span>
                                <h3>Engine Fields</h3>
                            </div>
                            <div class="section-progress" id="engine-progress">
                                <span class="progress-text">0 of 3 required mapped</span>
                            </div>
                        </div>
                        <p>Map fields for engine data (core)</p>
                        <p class="required-note"><small><strong>Required if any engine field is mapped:</strong> Engine Make<span class="required-asterisk">*</span>, Engine Model<span class="required-asterisk">*</span>, Engine Identifier<span class="required-asterisk">*</span></small></p>
                        
                        {% if engine_suggestions %}
                        <div class="auto-suggestions">
                            <h4>Auto-Detected Mappings</h4>
                            <p>We've detected some fields that might match your headers:</p>
                            <div class="suggestion-list">
                                {% for field, header in engine_suggestions.items %}
                                <div class="suggestion-item">
                                    <span class="field-name">{{ field|title|underscore_to_space }}</span>
                                    <span class="arrow">‚Üí</span>
                                    <span class="header-name">{{ header }}</span>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="applySuggestion('{{ field }}', '{{ header }}')">Apply</button>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="field-mappings">
                            {% for field in engine_form %}
                                {% if field.name in engine_core_keys %}
                                <div class="form-group {% if 'engine_make' in field.name and 'engine_make' in missing_fields.engines %}field-missing{% endif %}{% if 'engine_model' in field.name and 'engine_model' in missing_fields.engines %}field-missing{% endif %}{% if 'engine_identifier' in field.name and 'engine_identifier' in missing_fields.engines %}field-missing{% endif %}">
                                    <label for="{{ field.id_for_label }}">
                                        {{ field.label }}
                                        {% if 'engine_make' in field.name or 'engine_model' in field.name or 'engine_identifier' in field.name %}
                                            <span class="required-asterisk">*</span>
                                        {% endif %}
                                        {% if 'engine_make' in field.name and 'engine_make' in missing_fields.engines %}
                                            <span class="missing-field-indicator">‚Üê Missing!</span>
                                        {% endif %}
                                        {% if 'engine_model' in field.name and 'engine_model' in missing_fields.engines %}
                                            <span class="missing-field-indicator">‚Üê Missing!</span>
                                        {% endif %}
                                        {% if 'engine_identifier' in field.name and 'engine_identifier' in missing_fields.engines %}
                                            <span class="missing-field-indicator">‚Üê Missing!</span>
                                        {% endif %}
                                    </label>
                                    {{ field }}
                                    {% if field.errors %}
                                        <div class="field-error">
                                            {% for error in field.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            {% empty %}
                                <p>No engine fields detected.</p>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Parts Section -->
                    <div class="mapping-section-card part-section">
                        <div class="section-header">
                            <div class="section-title">
                                <span class="section-icon">üîß</span>
                                <h3>Part Fields</h3>
                            </div>
                            <div class="section-progress" id="part-progress">
                                <span class="progress-text">0 of 2 required mapped</span>
                            </div>
                        </div>
                        <p>Map fields for part data (optional)</p>
                        <p class="required-note"><small><strong>Required if any part field is mapped:</strong> Part Number<span class="required-asterisk">*</span>, Name<span class="required-asterisk">*</span></small></p>
                        
                        <div class="field-mappings">
                            {% for field in part_form %}
                                <div class="form-group {% if 'part_number' in field.name and 'part_number' in missing_fields.parts %}field-missing{% endif %}{% if 'name' in field.name and 'name' in missing_fields.parts %}field-missing{% endif %}">
                                    <label for="{{ field.id_for_label }}">
                                        {{ field.label }}
                                        {% if 'part_number' in field.name or 'name' in field.name %}
                                            <span class="required-asterisk">*</span>
                                        {% endif %}
                                        {% if 'part_number' in field.name and 'part_number' in missing_fields.parts %}
                                            <span class="missing-field-indicator">‚Üê Missing!</span>
                                        {% endif %}
                                        {% if 'name' in field.name and 'name' in missing_fields.parts %}
                                            <span class="missing-field-indicator">‚Üê Missing!</span>
                                        {% endif %}
                                    </label>
                                    {{ field }}
                                    {% if field.errors %}
                                        <div class="field-error">
                                            {% for error in field.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Vendors Section -->
                    <div class="mapping-section-card vendor-section">
                        <div class="section-header">
                            <div class="section-title">
                                <span class="section-icon">üè¢</span>
                                <h3>Vendor Fields</h3>
                            </div>
                        </div>
                        <p>Map fields for vendor data (optional)</p>
                        
                        <div class="field-mappings">
                            {% for field in vendor_form %}
                                <div class="form-group">
                                    <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                    {{ field }}
                                    {% if field.errors %}
                                        <div class="field-error">
                                            {% for error in field.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- More Engine Fields Section -->
                <div class="mapping-section-card">
                    <h3>More Engine Fields</h3>
                    <p>Map additional engine specifications and components (optional)</p>
                    
                    <div class="field-mappings three-columns">
                        {% for field in additional_engine_form %}
                            {% if field.name in engine_more_keys %}
                            <div class="form-group">
                                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                {{ field }}
                                {% if field.errors %}
                                    <div class="field-error">
                                        {% for error in field.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        {% empty %}
                            <p>None</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- Part Attributes Section -->
                <div class="mapping-section-card">
                    <div class="card-header flex justify-between items-center">
                        <h3>Part Attributes (All Categories)</h3>
                        <button type="button" class="btn btn-secondary" onclick="toggleSection('all-attrs')">Toggle</button>
                    </div>
                    <div id="all-attrs" class="card-body">
                        <p>Map CSV headers to part attributes. Attributes will only be applied if they belong to the part's category.</p>
                        
                        <!-- Quick filters -->
                        <div class="filter-controls mb-4">
                            <div class="filter-row">
                                <input type="text" id="category-filter" placeholder="Filter by category..." class="form-control" style="width: 200px;">
                                <input type="text" id="name-filter" placeholder="Filter by attribute name..." class="form-control" style="width: 200px;">
                            </div>
                        </div>
                        
                        <div class="field-mappings three-columns">
                            {% for attr in all_attrs %}
                                <div class="form-group attr-item" data-category="{{ attr.category.name|lower }}" data-name="{{ attr.name|lower }}">
                                    <label for="attr_map_{{ attr.id }}" class="block text-sm font-medium">
                                        {{ attr.category.name }} ‚Äî {{ attr.name }}
                                        {% if attr.is_required %}<span class="text-red-600">*</span>{% endif %}
                                        {% if attr.unit %}<span class="text-gray-500">({{ attr.unit }})</span>{% endif %}
                                    </label>
                                    <select name="attr_map_{{ attr.id }}" id="attr_map_{{ attr.id }}" class="form-select w-full">
                                        <option value="">‚Äî Select Header ‚Äî</option>
                                        {% for h in batch.discovered_headers %}
                                            <option value="{{ h }}"
                                                {% if submitted_attr_mappings %}
                                                    {# Check submitted data first (after validation error) #}
                                                    {% if submitted_attr_mappings|get_item:attr.id == h %}selected{% endif %}
                                                {% elif batch.mapping %}
                                                    {# Otherwise use saved mapping if exists #}
                                                    {% with sel=batch.mapping.part_attribute_mappings|get_item:attr.id|stringformat:"s" %}
                                                        {% if sel == h %}selected{% endif %}
                                                    {% endwith %}
                                                {% endif %}
                                            >{{ h }}</option>
                                        {% endfor %}
                                    </select>
                                    {% if attr.help_text %}<p class="text-xs text-gray-500 mt-1">{{ attr.help_text }}</p>{% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="mapping-options">
                    <h3>Import Name (Optional)</h3>
                    <p>Optionally name this mapping to save it for future imports.</p>
                    
                    <div class="form-group">
                        <label for="mapping_name">Import Name <small>(optional)</small></label>
                        <input type="text" name="mapping_name" id="mapping_name" class="form-control" placeholder="e.g., Standard Parts Import (leave blank for one-time import)" value="{{ mapping_name_value }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="mapping_description">Description</label>
                        <textarea name="mapping_description" id="mapping_description" class="form-control" rows="3" placeholder="Optional description of this import">{{ mapping_description_value }}</textarea>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Mapping & Continue</button>
                    <a href="{% url 'imports:options_step' batch.id %}" class="btn btn-secondary">Back</a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleSection(sectionId) {
    const section = document.getElementById(sectionId);
    const isPreview = sectionId === 'preview-data';
    
    if (section.style.display === 'none' || section.style.display === '') {
        section.style.display = 'block';
        if (isPreview) {
            document.getElementById('preview-toggle-icon').textContent = '‚ñº';
        }
    } else {
        section.style.display = 'none';
        if (isPreview) {
            document.getElementById('preview-toggle-icon').textContent = '‚ñ∂';
        }
    }
}

// Progress tracking and visual feedback
document.addEventListener('DOMContentLoaded', function() {
    // Filter functionality
    const categoryFilter = document.getElementById('category-filter');
    const nameFilter = document.getElementById('name-filter');
    const attrItems = document.querySelectorAll('.attr-item');
    
    function filterAttributes() {
        const categoryValue = categoryFilter.value.toLowerCase();
        const nameValue = nameFilter.value.toLowerCase();
        
        attrItems.forEach(function(item) {
            const category = item.getAttribute('data-category');
            const name = item.getAttribute('data-name');
            
            const categoryMatch = category.includes(categoryValue);
            const nameMatch = name.includes(nameValue);
            
            if (categoryMatch && nameMatch) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    if (categoryFilter) {
        categoryFilter.addEventListener('input', filterAttributes);
    }
    if (nameFilter) {
        nameFilter.addEventListener('input', filterAttributes);
    }
    
    // Visual feedback and progress tracking
    function updateFieldVisuals(selectElement) {
        const formGroup = selectElement.closest('.form-group');
        if (selectElement.value && selectElement.value !== '') {
            selectElement.classList.add('mapped');
            formGroup.classList.add('field-mapped');
            formGroup.classList.remove('required-unmapped');
        } else {
            selectElement.classList.remove('mapped');
            formGroup.classList.remove('field-mapped');
        }
        updateProgress();
    }
    
    function updateProgress() {
        // Machine progress
        const machineSelects = document.querySelectorAll('.machine-section select');
        const machineRequired = Array.from(machineSelects).filter(s => 
            s.name.includes('make') || s.name.includes('model')
        );
        const machineMapped = machineRequired.filter(s => s.value && s.value !== '');
        updateProgressDisplay('machine-progress', machineMapped.length, machineRequired.length);
        
        // Engine progress
        const engineSelects = document.querySelectorAll('.engine-section select');
        const engineRequired = Array.from(engineSelects).filter(s => 
            s.name.includes('engine_make') || s.name.includes('engine_model') || s.name.includes('engine_identifier')
        );
        const engineMapped = engineRequired.filter(s => s.value && s.value !== '');
        updateProgressDisplay('engine-progress', engineMapped.length, engineRequired.length);
        
        // Part progress
        const partSelects = document.querySelectorAll('.part-section select');
        const partRequired = Array.from(partSelects).filter(s => 
            s.name.includes('part_number') || (s.name.includes('name') && s.name.includes('part'))
        );
        const partMapped = partRequired.filter(s => s.value && s.value !== '');
        updateProgressDisplay('part-progress', partMapped.length, partRequired.length);
    }
    
    function updateProgressDisplay(elementId, mapped, total) {
        const progressEl = document.getElementById(elementId);
        if (progressEl) {
            const text = progressEl.querySelector('.progress-text');
            if (text) {
                text.textContent = `${mapped} of ${total} required mapped`;
                
                // Add/remove badge
                let badge = progressEl.querySelector('.progress-badge');
                if (mapped === total && total > 0) {
                    if (!badge) {
                        badge = document.createElement('span');
                        badge.className = 'progress-badge';
                        progressEl.appendChild(badge);
                    }
                    badge.textContent = 'Complete';
                    badge.classList.remove('incomplete');
                } else if (mapped > 0 && mapped < total) {
                    if (!badge) {
                        badge = document.createElement('span');
                        badge.className = 'progress-badge incomplete';
                        progressEl.appendChild(badge);
                    }
                    badge.textContent = `${total - mapped} left`;
                    badge.classList.add('incomplete');
                } else if (badge) {
                    badge.remove();
                }
            }
        }
    }
    
    
    // Attach change listeners to all select fields
    const allSelects = document.querySelectorAll('select');
    allSelects.forEach(select => {
        select.addEventListener('change', function() {
            updateFieldVisuals(this);
        });
        // Initialize visuals
        updateFieldVisuals(select);
    });
    
    // Initial progress update
    updateProgress();
});

// Auto-suggestion functionality
function applySuggestion(fieldName, headerName) {
    // Find the corresponding select field
    const fieldId = `id_map_engines_${fieldName}`;
    const selectField = document.getElementById(fieldId);
    
    if (selectField) {
        // Set the value
        selectField.value = headerName;
        
        // Add visual feedback
        selectField.style.backgroundColor = '#d4edda';
        selectField.style.borderColor = '#c3e6cb';
        
        // Remove highlight after 2 seconds
        setTimeout(() => {
            selectField.style.backgroundColor = '';
            selectField.style.borderColor = '';
        }, 2000);
        
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.className = 'alert alert-success';
        successMsg.textContent = `Applied: ${fieldName} ‚Üí ${fieldName.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())} ‚Üí ${headerName}`;
        successMsg.style.marginTop = '0.5rem';
        successMsg.style.fontSize = '0.875rem';
        successMsg.style.color = '#155724';
        successMsg.style.backgroundColor = '#d4edda';
        successMsg.style.border = '1px solid #c3e6cb';
        successMsg.style.borderRadius = '0.25rem';
        successMsg.style.padding = '0.5rem';
        
        selectField.parentNode.appendChild(successMsg);
        
        // Remove message after 3 seconds
        setTimeout(() => {
            successMsg.remove();
        }, 3000);
    }
}
</script>
{% endblock %}

{% block extra_css %}
<style>
.wizard-header {
    margin-bottom: var(--spacing-xl);
}

.wizard-steps {
    display: flex;
    justify-content: space-between;
    margin-top: var(--spacing-lg);
    max-width: 600px;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    position: relative;
}

.step:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 20px;
    left: 50%;
    width: 100%;
    height: 2px;
    background-color: var(--gray-300);
    z-index: 1;
}

.step.active::after {
    background-color: var(--primary);
}

.step.completed::after {
    background-color: var(--success);
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: var(--gray-300);
    color: var(--gray-600);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    position: relative;
    z-index: 2;
}

.step.active .step-number {
    background-color: var(--primary);
    color: white;
}

.step.completed .step-number {
    background-color: var(--success);
    color: white;
}

.step-label {
    margin-top: var(--spacing-sm);
}

.auto-suggestions {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 1rem;
}

.auto-suggestions h4 {
    color: #495057;
    margin-bottom: 0.5rem;
    font-size: 1rem;
    font-weight: 600;
}

.auto-suggestions p {
    color: #6c757d;
    margin-bottom: 1rem;
    font-size: 0.875rem;
}

.suggestion-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.suggestion-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    background-color: white;
    border: 1px solid #e9ecef;
    border-radius: 0.25rem;
}

.suggestion-item .field-name {
    font-weight: 600;
    color: #495057;
    min-width: 120px;
}

.suggestion-item .arrow {
    color: #6c757d;
    font-weight: bold;
}

.suggestion-item .header-name {
    color: #495057;
    flex: 1;
    font-family: monospace;
    background-color: #f8f9fa;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
}
    font-size: var(--font-size-sm);
    color: var(--gray-600);
    text-align: center;
}

.step.active .step-label {
    color: var(--primary);
    font-weight: 500;
}

.step.completed .step-label {
    color: var(--success);
    font-weight: 500;
}

.wizard-content {
    max-width: 1400px;
    margin: 0 auto;
}

.mapping-section {
    background: white;
    padding: 16px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
}

.file-info {
    background: var(--gray-50);
    padding: 10px 12px;
    border-radius: var(--border-radius);
    margin-bottom: 12px;
}

.file-info h3 {
    font-size: 1em;
    margin-bottom: 6px;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 8px;
    margin-top: 6px;
}

.info-item {
    display: flex;
    flex-direction: column;
}

.info-item label {
    font-weight: 500;
    color: var(--gray-700);
    margin-bottom: 2px;
    font-size: 0.9em;
}

.info-item span {
    color: var(--gray-600);
    font-size: 0.9em;
}

.mapping-sections {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 16px;
    margin-bottom: 16px;
}

.mapping-section-card {
    background: white;
    padding: 16px;
    border-radius: 8px;
    border: 1px solid var(--gray-200);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.mapping-section-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    transition: opacity 0.3s ease;
}

.mapping-section-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

/* Color-coded sections */
.machine-section {
    border-top: 4px solid #2196F3;
    background: linear-gradient(to bottom, #E3F2FD 0%, white 100px);
}

.engine-section {
    border-top: 4px solid #FF9800;
    background: linear-gradient(to bottom, #FFF3E0 0%, white 100px);
}

.part-section {
    border-top: 4px solid #4CAF50;
    background: linear-gradient(to bottom, #E8F5E9 0%, white 100px);
}

.vendor-section {
    border-top: 4px solid #9C27B0;
    background: linear-gradient(to bottom, #F3E5F5 0%, white 100px);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.section-title {
    display: flex;
    align-items: center;
    gap: 8px;
}

.section-icon {
    font-size: 1.5em;
    line-height: 1;
}

.mapping-section-card h3 {
    margin: 0;
    color: var(--gray-800);
    font-size: 1.1em;
    font-weight: 600;
}

.mapping-section-card p {
    color: var(--gray-600);
    font-size: 0.85em;
    margin-bottom: 8px;
    line-height: 1.3;
}

 .field-mappings {
     display: flex;
     flex-direction: column;
     gap: 8px;
 }
 
 .field-mappings.three-columns {
     display: grid;
     grid-template-columns: repeat(3, 1fr);
     gap: 8px;
 }
 
 @media (max-width: 1024px) {
     .field-mappings.three-columns {
         grid-template-columns: repeat(2, 1fr);
     }
 }
 
 @media (max-width: 768px) {
     .field-mappings.three-columns {
         grid-template-columns: 1fr;
     }
 }

/* Progress indicators */
.section-progress {
    display: flex;
    align-items: center;
    gap: 6px;
}

.progress-text {
    font-size: 0.75em;
    color: #666;
    font-weight: 500;
}

.progress-badge {
    background: #4CAF50;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75em;
    font-weight: 600;
}

.progress-badge.incomplete {
    background: #ff9800;
}

/* Compact form controls with visual feedback */
.form-group {
    margin-bottom: 0;
    position: relative;
}

.form-group label {
    font-size: 0.9em;
    margin-bottom: 3px;
    display: block;
    font-weight: 500;
    transition: color 0.3s ease;
}

.form-group select,
.form-group input,
.form-group textarea {
    padding: 6px 8px;
    font-size: 0.9em;
    height: auto;
    transition: all 0.3s ease;
    border: 2px solid #ddd;
}

.form-group select:focus,
.form-group input:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #2196F3;
    box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
}

/* Mapped field indicator */
.form-group select.mapped {
    border-color: #4CAF50;
    background-color: #f1f8f4;
}

.form-group.field-mapped label::after {
    content: ' ‚úì';
    color: #4CAF50;
    font-weight: bold;
    margin-left: 4px;
}

.form-control {
    padding: 6px 8px;
    font-size: 0.9em;
}

.mapping-options {
    background: var(--blue-50);
    padding: 12px;
    border-radius: var(--border-radius);
    border: 1px solid var(--blue-200);
    margin-bottom: 16px;
}

.mapping-options h3 {
    margin-top: 0;
    margin-bottom: 4px;
    color: var(--blue-800);
    font-size: 1.1em;
}

.mapping-options p {
    color: var(--blue-700);
    font-size: 0.85em;
    margin-bottom: 8px;
}

.mapping-options .form-group {
    margin-bottom: 10px;
}

.preview-section {
    border-top: 1px solid var(--gray-200);
    padding-top: 12px;
    margin-top: 8px;
}

.preview-section h3 {
    font-size: 1em;
    margin-bottom: 8px;
}

.preview-table {
    font-size: 0.85em;
}

.preview-table th {
    background: var(--gray-100);
    font-weight: 600;
    padding: 6px 8px;
}

.preview-table td {
    padding: 5px 8px;
}

.form-actions {
    display: flex;
    gap: 10px;
    margin-top: 16px;
}

/* Enhanced button styles */
.btn-primary {
    background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(33, 150, 243, 0.3);
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
    background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
}

.btn-primary:active {
    transform: translateY(0);
}

.btn-primary::before {
    content: 'üíæ';
    font-size: 1em;
}

.btn-secondary {
    background: white;
    color: #666;
    border: 2px solid #ddd;
    padding: 10px 20px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-secondary:hover {
    border-color: #2196F3;
    color: #2196F3;
    transform: translateY(-1px);
}

.btn-secondary::before {
    content: '‚Üê';
    font-size: 1.2em;
}

/* Status badges */
.status-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75em;
    font-weight: 600;
    margin-left: 6px;
}

.badge-required {
    background: #ffebee;
    color: #c62828;
}

.badge-optional {
    background: #f5f5f5;
    color: #757575;
}

/* Part Attributes Section Styles */
.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.card-header h3 {
    margin: 0;
    font-size: 1.1em;
}

.filter-controls {
    margin-bottom: 8px;
}

.filter-row {
    display: flex;
    gap: 8px;
    align-items: center;
}

.filter-row input {
    padding: 5px 8px;
    border: 1px solid var(--gray-300);
    border-radius: var(--border-radius);
    font-size: 0.85em;
}

.attr-item {
    border: 1px solid var(--gray-200);
    padding: 8px;
    border-radius: var(--border-radius);
    background: white;
}

.attr-item label {
    font-weight: 500;
    color: var(--gray-700);
    margin-bottom: 3px;
    display: block;
    font-size: 0.85em;
}

.attr-item select {
    width: 100%;
    padding: 5px 6px;
    border: 1px solid var(--gray-300);
    border-radius: var(--border-radius);
    font-size: 0.85em;
}

.attr-item p {
    margin-top: 2px;
    font-size: 0.75em;
    color: var(--gray-500);
}

/* Required field styling */
.required-asterisk {
    color: #dc3545;
    font-weight: bold;
    margin-left: 2px;
}

.required-note {
    background-color: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 4px;
    padding: 6px 10px;
    margin-top: 4px;
    margin-bottom: 6px;
    color: #856404;
    font-size: 0.85em;
    line-height: 1.3;
}

.required-note strong {
    color: #856404;
}

/* Missing field styling */
.field-missing {
    background-color: #ffe6e6 !important;
    border: 2px solid #dc3545 !important;
    border-radius: 4px;
    padding: 8px;
    animation: pulse-red 2s ease-in-out;
}

.field-missing label {
    color: #dc3545;
    font-weight: 600;
}

.field-missing select {
    border: 2px solid #dc3545 !important;
    background-color: #fff;
}

.missing-field-indicator {
    color: #dc3545;
    font-weight: bold;
    margin-left: 8px;
    font-size: 0.9em;
    animation: blink 1.5s ease-in-out infinite;
}

@keyframes pulse-red {
    0%, 100% {
        background-color: #ffe6e6;
    }
    50% {
        background-color: #ffcccc;
    }
}

@keyframes blink {
    0%, 50%, 100% {
        opacity: 1;
    }
    25%, 75% {
        opacity: 0.5;
    }
}

/* Page load animations */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.mapping-section-card {
    animation: fadeInUp 0.5s ease-out;
}

.machine-section {
    animation-delay: 0.1s;
}

.engine-section {
    animation-delay: 0.2s;
}

.part-section {
    animation-delay: 0.3s;
}

.vendor-section {
    animation-delay: 0.4s;
}

/* Smooth scroll behavior */
html {
    scroll-behavior: smooth;
}


/* Pulse animation for unmapped required fields */
@keyframes gentle-pulse {
    0%, 100% {
        box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.4);
    }
    50% {
        box-shadow: 0 0 0 8px rgba(255, 152, 0, 0);
    }
}

.form-group.required-unmapped select {
    animation: gentle-pulse 2s infinite;
}
</style>
{% endblock %}


