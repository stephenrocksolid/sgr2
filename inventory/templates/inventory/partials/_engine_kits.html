{% load static %}

<h2 class="section-title">Build List</h2>

{% if kits %}
    <table class="related-table">
        <thead>
            <tr>
                <th>Kit Name</th>
                <th>Cost</th>
                <th>Margin %</th>
                <th>Sale Price</th>
                <th>Last Updated</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for kit in kits %}
                <tr>
                    <td>
                        <strong>{{ kit.name }}</strong>
                        {% if kit.notes %}
                            <br><small class="text-muted">{{ kit.notes|truncatechars:100 }}</small>
                        {% endif %}
                    </td>
                    <td>${{ kit.cost_total|floatformat:2 }}</td>
                    <td>{{ kit.margin_pct }}%</td>
                    <td>${{ kit.sale_price|floatformat:2 }}</td>
                    <td>{{ kit.updated_at|date:"M j, Y g:i A" }}</td>
                    <td>
                        <div class="action-buttons">
                            <a href="{% url 'inventory:kit_detail' kit.id %}" 
                               class="btn btn-sm btn-primary">
                                Open
                            </a>
                            <button class="btn btn-sm btn-secondary" 
                                    onclick="editKit({{ kit.id }}, '{{ kit.name|escapejs }}', '{{ kit.notes|escapejs }}', '{{ kit.margin_pct }}')">
                                Rename
                            </button>
                            <button class="btn btn-sm btn-info" 
                                    hx-post="{% url 'inventory:kit_duplicate' kit.id %}"
                                    hx-target="#build-list-section"
                                    hx-swap="innerHTML">
                                Duplicate
                            </button>
                            <button class="btn btn-sm btn-danger" 
                                    hx-post="{% url 'inventory:kit_delete' kit.id %}"
                                    hx-target="#build-list-section"
                                    hx-swap="innerHTML"
                                    hx-confirm="Are you sure you want to delete this kit? This will also delete all items within it.">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <div class="empty-message">
        No kits have been created for this engine.
    </div>
{% endif %}

<div class="mt-3">
    <button class="btn btn-primary"
            hx-get="{% url 'inventory:engine_kit_add_form' engine.id %}"
            hx-target="#add-kit-form"
            hx-swap="innerHTML">
        Add Kit
    </button>
</div>

<div id="add-kit-form" class="mt-3"></div>

<!-- Edit Kit Modal -->
<div id="edit-kit-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Kit</h3>
            <span class="close" onclick="closeEditKitModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="edit-kit-form">
                <div class="form-group">
                    <label for="edit_kit_name">Name *</label>
                    <input type="text" name="name" id="edit_kit_name" required>
                </div>
                <div class="form-group">
                    <label for="edit_kit_notes">Notes</label>
                    <textarea name="notes" id="edit_kit_notes" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="edit_kit_margin">Margin %</label>
                    <input type="number" name="margin_pct" id="edit_kit_margin" step="0.01" min="0">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditKitModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.action-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: var(--border-radius);
    width: 90%;
    max-width: 600px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--gray-200);
}

.modal-header h3 {
    margin: 0;
    color: var(--gray-900);
}

.close {
    color: var(--gray-400);
    font-size: 1.5rem;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: var(--gray-600);
}

.modal-body {
    padding: 1.5rem;
}
</style>

<script>
function editKit(kitId, name, notes, marginPct) {
    // Populate the modal form
    document.getElementById('edit_kit_name').value = name;
    document.getElementById('edit_kit_notes').value = notes;
    document.getElementById('edit_kit_margin').value = marginPct;
    
    // Set up the form submission
    const form = document.getElementById('edit-kit-form');
    form.onsubmit = function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        fetch(`/inventory/kits/${kitId}/rename/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            }
        })
        .then(response => response.text())
        .then(html => {
            document.getElementById('build-list-section').innerHTML = html;
            closeEditKitModal();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the kit.');
        });
    };
    
    // Show the modal
    document.getElementById('edit-kit-modal').style.display = 'block';
}

function closeEditKitModal() {
    document.getElementById('edit-kit-modal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('edit-kit-modal');
    if (event.target === modal) {
        closeEditKitModal();
    }
}
</script>
