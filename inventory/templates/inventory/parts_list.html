{% extends "base.html" %}
{% load static %}

{% block title %}Parts - SGR Part Manager{% endblock %}

{% block extra_css %}
<style>
/* Page Layout */
.part-list-page {
    max-width: calc(100% - 2rem);
    margin: 0 auto;
    padding: 0 1rem;
    margin-top: -1.25rem;
}

/* Header */
.part-list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.part-list-header-left {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.part-list-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--gray-900);
    margin: 0;
}

.part-list-title svg {
    color: var(--gray-500);
    width: 26px;
    height: 26px;
}

.part-list-count {
    padding: 0.25rem 0.5rem;
    background: var(--gray-100);
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--gray-600);
}

.btn-create {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 1rem;
    font-size: 0.8125rem;
    font-weight: 600;
}

.btn-create svg {
    width: 14px;
    height: 14px;
}

/* Filter Bar */
.part-filter-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: 0.375rem;
}

.part-search-wrapper {
    position: relative;
    flex: 1;
    max-width: 320px;
}

.part-search-icon {
    position: absolute;
    left: 0.625rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-400);
    pointer-events: none;
    width: 14px;
    height: 14px;
}

.part-search-form {
    width: 100%;
}

.part-search-input {
    width: 100%;
    padding: 0.375rem 2rem 0.375rem 2rem;
    border: 1px solid var(--gray-300);
    border-radius: 0.25rem;
    font-size: 0.8125rem;
    background: var(--gray-50);
    transition: all 0.15s ease;
}

.part-search-input:focus {
    outline: none;
    background: white;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(74, 85, 104, 0.1);
}

.part-search-clear {
    position: absolute;
    right: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    padding: 0;
    border: none;
    background: var(--gray-300);
    border-radius: 50%;
    color: var(--gray-600);
    cursor: pointer;
    transition: all 0.15s ease;
}

.part-search-clear:hover {
    background: var(--gray-400);
    color: var(--gray-800);
}

.part-filter-tabs {
    display: flex;
    gap: 0.125rem;
    flex-wrap: wrap;
}

.part-filter-tab {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--gray-600);
    text-decoration: none;
    border-radius: 0.25rem;
    transition: all 0.15s ease;
    white-space: nowrap;
}

.part-filter-tab:hover {
    background: var(--gray-100);
    color: var(--gray-900);
}

.part-filter-tab.active {
    background: var(--primary);
    color: white;
}

/* Table Card */
.part-table-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: 0.375rem;
    overflow: auto;
    height: calc(100vh - 195px);
}

.part-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

.part-table thead {
    background: var(--gray-50);
    position: sticky;
    top: 0;
    z-index: 10;
}

.part-table th {
    padding: 0.4rem 0.75rem;
    text-align: left;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--gray-500);
    border-bottom: 2px solid var(--gray-200);
    background: var(--gray-50);
    white-space: nowrap;
}

.part-table th:first-child { padding-left: 1rem; }
.part-table th:last-child { padding-right: 1rem; }

.part-sort-link {
    color: var(--gray-500);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    transition: color 0.15s ease;
    cursor: pointer;
}

.part-sort-link:hover,
.part-sort-link.active {
    color: var(--gray-900);
}

.sort-indicator {
    font-size: 0.7rem;
    color: var(--gray-400);
    min-width: 1rem;
}

.sort-indicator.active {
    color: var(--primary);
    font-weight: 700;
}

/* Table Rows */
.part-row {
    cursor: pointer;
    transition: background 0.15s ease;
}

.part-row:hover {
    background: #f8fafc;
}

.part-row:hover td {
    background: #f8fafc;
}

.part-table td {
    padding: 0.35rem 0.75rem;
    border-bottom: 1px solid var(--gray-100);
    vertical-align: middle;
    font-size: 0.8125rem;
}

.part-table td:first-child { padding-left: 1rem; }
.part-table td:last-child { padding-right: 1rem; }

.part-row:last-child td {
    border-bottom: none;
}

/* Part Number Cell */
.part-number-text {
    font-weight: 600;
    color: var(--gray-900);
    font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
}

/* Part Name Cell */
.part-name-text {
    font-weight: 500;
    color: var(--gray-800);
}

/* Category Badge */
.part-category-badge {
    display: inline-flex;
    padding: 0.2rem 0.5rem;
    background: #eef2ff;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    color: #4f46e5;
}

/* Manufacturer Text */
.part-manufacturer-text {
    color: var(--gray-700);
}

/* Type Badge */
.part-type-badge {
    display: inline-flex;
    padding: 0.2rem 0.5rem;
    background: #f1f5f9;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--gray-700);
}

/* Vendor Badge */
.part-vendor-badge {
    display: inline-flex;
    padding: 0.2rem 0.5rem;
    background: #fef3c7;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    color: #b45309;
}

.part-vendor-count {
    display: inline-flex;
    padding: 0.1rem 0.35rem;
    margin-left: 0.25rem;
    background: var(--gray-200);
    border-radius: 9999px;
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--gray-600);
}

.part-no-data {
    color: var(--gray-300);
    font-weight: 400;
}

/* Empty State */
.part-empty-state {
    padding: 3rem 2rem !important;
    text-align: center;
}

.part-empty-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
}

.part-empty-content svg {
    color: var(--gray-300);
    width: 40px;
    height: 40px;
}

.part-empty-content h3 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--gray-700);
}

.part-empty-content p {
    margin: 0;
    font-size: 0.875rem;
    color: var(--gray-500);
}

/* Pagination */
.part-pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: 0.375rem;
}

.part-pagination-info {
    font-size: 0.75rem;
    color: var(--gray-600);
}

.part-pagination-controls {
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

.part-page-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 26px;
    height: 26px;
    border: 1px solid var(--gray-300);
    border-radius: 0.25rem;
    color: var(--gray-600);
    background: white;
    text-decoration: none;
    transition: all 0.15s ease;
}

.part-page-btn svg {
    width: 12px;
    height: 12px;
}

.part-page-btn:hover {
    background: var(--gray-50);
    border-color: var(--gray-400);
}

.part-page-current {
    padding: 0 0.625rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--gray-700);
}

/* Modal Styles */
.part-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.part-modal-content {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    max-width: 550px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.part-modal-header {
    padding: 0.875rem 1rem;
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.part-modal-header h3 {
    margin: 0;
    color: var(--gray-900);
    font-size: 1rem;
    font-weight: 600;
}

.part-modal-close {
    background: none;
    border: none;
    font-size: 1.25rem;
    cursor: pointer;
    color: var(--gray-400);
    padding: 0;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.15s ease;
}

.part-modal-close:hover {
    background: var(--gray-100);
    color: var(--gray-700);
}

.part-modal-body {
    padding: 1rem;
}

.part-modal-help {
    font-size: 0.8125rem;
    color: var(--gray-500);
    margin: 0 0 0.75rem 0;
    padding: 0.5rem 0.75rem;
    background: var(--gray-50);
    border-radius: 4px;
}

.part-modal-footer {
    padding: 0.75rem 1rem;
    border-top: 1px solid var(--gray-200);
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
}

/* Search Conditions */
.search-condition {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    margin-bottom: 0.5rem;
    padding: 0.5rem;
    background: var(--gray-50);
    border-radius: 0.375rem;
}

.search-condition select,
.search-condition input {
    padding: 0.375rem 0.5rem;
    border: 1px solid var(--gray-300);
    border-radius: 0.25rem;
    font-size: 0.8125rem;
}

.field-select {
    min-width: 100px;
}

.operator-select {
    min-width: 90px;
}

.value-input {
    flex: 1;
    min-width: 120px;
}

.btn-icon {
    padding: 0.375rem;
    color: var(--gray-500);
}

.btn-icon:hover {
    color: var(--error);
    background: #fee2e2;
}

/* Button Variants */
.btn-sm {
    padding: 0.375rem 0.625rem;
    font-size: 0.75rem;
}

/* Responsive */
@media (max-width: 768px) {
    .part-list-header {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
    }
    
    .part-list-header-left {
        justify-content: space-between;
    }
    
    .part-list-header-right {
        display: flex;
        justify-content: flex-end;
    }
    
    .part-filter-bar {
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;
    }
    
    .part-search-wrapper {
        max-width: none;
    }
    
    .part-filter-tabs {
        overflow-x: auto;
        padding-bottom: 0.25rem;
        justify-content: flex-start;
    }
    
    .part-th-type, .part-cell-type,
    .part-th-vendor, .part-cell-vendor {
        display: none;
    }
    
    .search-condition {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-condition select,
    .search-condition input {
        width: 100%;
    }
}

@media (max-width: 640px) {
    .part-pagination {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .part-th-category, .part-cell-category,
    .part-th-manufacturer, .part-cell-manufacturer {
        display: none;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="part-list-page">
    <!-- Page Header -->
    <div class="part-list-header">
        <div class="part-list-header-left">
            <h1 class="part-list-title">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                </svg>
                Parts
            </h1>
            <span class="part-list-count">{{ total_count }} total</span>
        </div>
        <div class="part-list-header-right">
            <a href="{% url 'inventory:part_create' %}" class="btn btn-primary btn-create">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                New Part
            </a>
        </div>
    </div>

    <!-- Search & Filter Bar -->
    <div class="part-filter-bar">
        <div class="part-search-wrapper">
            <svg class="part-search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <form method="get" class="part-search-form" id="searchForm">
                <input type="text" name="q" value="{{ q }}" class="part-search-input" placeholder="Search by part number, name, manufacturer...">
                <input type="hidden" name="sort" value="{{ sort }}">
                <input type="hidden" name="category_filter" value="{{ category_filter }}">
            </form>
            {% if q %}
            <button type="button" class="part-search-clear" onclick="clearSearch()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            {% endif %}
        </div>
        <div class="part-filter-tabs">
            <a href="?category_filter=all{% if q %}&q={{ q }}{% endif %}&sort={{ sort }}" class="part-filter-tab {% if category_filter == 'all' or not category_filter %}active{% endif %}">
                All
            </a>
            {% for cat in unique_categories %}
            <a href="?category_filter={{ cat }}{% if q %}&q={{ q }}{% endif %}&sort={{ sort }}" class="part-filter-tab {% if category_filter == cat %}active{% endif %}">
                {{ cat|truncatechars:15 }}
            </a>
            {% endfor %}
        </div>
        <button type="button" class="btn btn-sm btn-outline" data-open="adv-search">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="4" y1="21" x2="4" y2="14"></line>
                <line x1="4" y1="10" x2="4" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12" y2="3"></line>
                <line x1="20" y1="21" x2="20" y2="16"></line>
                <line x1="20" y1="12" x2="20" y2="3"></line>
                <line x1="1" y1="14" x2="7" y2="14"></line>
                <line x1="9" y1="8" x2="15" y2="8"></line>
                <line x1="17" y1="16" x2="23" y2="16"></line>
            </svg>
            Advanced
        </button>
    </div>

    <!-- Advanced Search Modal -->
    <div id="adv-search" class="part-modal" style="display: none;">
        <div class="part-modal-content">
            <div class="part-modal-header">
                <h3>Advanced Search</h3>
                <button type="button" class="part-modal-close" data-close="adv-search">&times;</button>
            </div>
            <div class="part-modal-body">
                <p class="part-modal-help">Use field:value syntax. Example: number:12345 name:filter vendor:acme</p>
                <div id="search-conditions">
                    <div class="search-condition">
                        <select class="field-select">
                            <option value="number">Part Number</option>
                            <option value="name">Name</option>
                            <option value="mfr">Manufacturer</option>
                            <option value="category">Category</option>
                            <option value="type">Type</option>
                            <option value="vendor">Vendor</option>
                        </select>
                        <select class="operator-select">
                            <option value="contains">contains</option>
                            <option value="is">is exactly</option>
                        </select>
                        <input type="text" class="value-input" placeholder="Enter value...">
                        <button type="button" class="btn btn-sm btn-icon remove-condition">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-outline" id="add-condition">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Add Condition
                </button>
            </div>
            <div class="part-modal-footer">
                <button type="button" class="btn btn-outline" data-close="adv-search">Cancel</button>
                <button type="button" class="btn btn-primary" id="apply-advanced-search">Apply Search</button>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="part-table-card">
        <table class="part-table">
            <thead>
                <tr>
                    <th class="part-th-number">
                        <a href="#" class="part-sort-link" data-field="part_number">
                            Part Number <span class="sort-indicator"></span>
                        </a>
                    </th>
                    <th class="part-th-name">
                        <a href="#" class="part-sort-link" data-field="name">
                            Name <span class="sort-indicator"></span>
                        </a>
                    </th>
                    <th class="part-th-category">
                        <a href="#" class="part-sort-link" data-field="category__name">
                            Category <span class="sort-indicator"></span>
                        </a>
                    </th>
                    <th class="part-th-manufacturer">
                        <a href="#" class="part-sort-link" data-field="manufacturer">
                            Manufacturer <span class="sort-indicator"></span>
                        </a>
                    </th>
                    <th class="part-th-type">
                        <a href="#" class="part-sort-link" data-field="type">
                            Type <span class="sort-indicator"></span>
                        </a>
                    </th>
                    <th class="part-th-vendor">Vendor</th>
                </tr>
            </thead>
            <tbody>
                {% for part in parts %}
                <tr class="part-row" onclick="window.location='{% url 'inventory:part_edit' part.pk %}'">
                    <td class="part-cell-number">
                        <span class="part-number-text">{{ part.part_number|default:"—" }}</span>
                    </td>
                    <td class="part-cell-name">
                        <span class="part-name-text">{{ part.name|default:"—" }}</span>
                    </td>
                    <td class="part-cell-category">
                        {% if part.category %}
                        <span class="part-category-badge">{{ part.category.name }}</span>
                        {% else %}
                        <span class="part-no-data">—</span>
                        {% endif %}
                    </td>
                    <td class="part-cell-manufacturer">
                        {% if part.manufacturer %}
                        <span class="part-manufacturer-text">{{ part.manufacturer }}</span>
                        {% else %}
                        <span class="part-no-data">—</span>
                        {% endif %}
                    </td>
                    <td class="part-cell-type">
                        {% if part.type %}
                        <span class="part-type-badge">{{ part.type }}</span>
                        {% else %}
                        <span class="part-no-data">—</span>
                        {% endif %}
                    </td>
                    <td class="part-cell-vendor">
                        {% if part.primary_vendor %}
                        <span class="part-vendor-badge">{{ part.primary_vendor.name }}</span>
                        {% with vendor_count=part.vendor_links.count %}
                            {% if vendor_count > 1 %}
                            <span class="part-vendor-count">+{{ vendor_count|add:"-1" }}</span>
                            {% endif %}
                        {% endwith %}
                        {% else %}
                        {% with vendor_count=part.vendor_links.count %}
                            {% if vendor_count > 0 %}
                            <span class="part-vendor-badge">{{ part.vendor_links.first.vendor.name }}</span>
                            {% if vendor_count > 1 %}
                            <span class="part-vendor-count">+{{ vendor_count|add:"-1" }}</span>
                            {% endif %}
                            {% else %}
                            <span class="part-no-data">—</span>
                            {% endif %}
                        {% endwith %}
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="part-empty-state">
                        <div class="part-empty-content">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                            </svg>
                            <h3>No parts found</h3>
                            <p>{% if q %}Try a different search term{% else %}No parts match the current filters{% endif %}</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="part-pagination">
        <div class="part-pagination-info">
            Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ total_count }}
        </div>
        <div class="part-pagination-controls">
            {% if page_obj.has_previous %}
            <a href="?{% if q %}q={{ q }}&{% endif %}{% if category_filter %}category_filter={{ category_filter }}&{% endif %}sort={{ sort }}&page=1" class="part-page-btn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="11 17 6 12 11 7"></polyline>
                    <polyline points="18 17 13 12 18 7"></polyline>
                </svg>
            </a>
            <a href="?{% if q %}q={{ q }}&{% endif %}{% if category_filter %}category_filter={{ category_filter }}&{% endif %}sort={{ sort }}&page={{ page_obj.previous_page_number }}" class="part-page-btn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </a>
            {% endif %}
            
            <span class="part-page-current">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            
            {% if page_obj.has_next %}
            <a href="?{% if q %}q={{ q }}&{% endif %}{% if category_filter %}category_filter={{ category_filter }}&{% endif %}sort={{ sort }}&page={{ page_obj.next_page_number }}" class="part-page-btn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </a>
            <a href="?{% if q %}q={{ q }}&{% endif %}{% if category_filter %}category_filter={{ category_filter }}&{% endif %}sort={{ sort }}&page={{ page_obj.paginator.num_pages }}" class="part-page-btn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="13 17 18 12 13 7"></polyline>
                    <polyline points="6 17 11 12 6 7"></polyline>
                </svg>
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Submit search on enter
    const searchInput = document.querySelector('.part-search-input');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                this.form.submit();
            }
        });
    }
    
    // Modal functionality
    const modal = document.getElementById('adv-search');
    const openBtns = document.querySelectorAll('[data-open="adv-search"]');
    const closeBtns = document.querySelectorAll('[data-close="adv-search"]');
    
    function openModal() {
        modal.style.display = 'flex';
    }
    
    function closeModal() {
        modal.style.display = 'none';
    }
    
    openBtns.forEach(btn => btn.addEventListener('click', openModal));
    closeBtns.forEach(btn => btn.addEventListener('click', closeModal));
    
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });
    
    // Add condition functionality
    const addConditionBtn = document.getElementById('add-condition');
    const conditionsContainer = document.getElementById('search-conditions');
    
    function createConditionElement() {
        const conditionDiv = document.createElement('div');
        conditionDiv.className = 'search-condition';
        conditionDiv.innerHTML = `
            <select class="field-select">
                <option value="number">Part Number</option>
                <option value="name">Name</option>
                <option value="mfr">Manufacturer</option>
                <option value="category">Category</option>
                <option value="type">Type</option>
                <option value="vendor">Vendor</option>
            </select>
            <select class="operator-select">
                <option value="contains">contains</option>
                <option value="is">is exactly</option>
            </select>
            <input type="text" class="value-input" placeholder="Enter value...">
            <button type="button" class="btn btn-sm btn-icon remove-condition">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        `;
        
        const removeBtn = conditionDiv.querySelector('.remove-condition');
        removeBtn.addEventListener('click', function() {
            conditionDiv.remove();
        });
        
        return conditionDiv;
    }
    
    if (addConditionBtn) {
        addConditionBtn.addEventListener('click', function() {
            const newCondition = createConditionElement();
            conditionsContainer.appendChild(newCondition);
        });
    }
    
    // Remove condition functionality for existing conditions
    document.querySelectorAll('.remove-condition').forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.search-condition').remove();
        });
    });
    
    // Apply advanced search
    const applyBtn = document.getElementById('apply-advanced-search');
    
    if (applyBtn) {
        applyBtn.addEventListener('click', function() {
            const conditions = document.querySelectorAll('.search-condition');
            const queryParts = [];
            
            conditions.forEach(condition => {
                const field = condition.querySelector('.field-select').value;
                const operator = condition.querySelector('.operator-select').value;
                const value = condition.querySelector('.value-input').value.trim();
                
                if (value) {
                    let queryPart = `${field}:`;
                    if (operator === 'is' || value.includes(' ')) {
                        queryPart += `"${value}"`;
                    } else {
                        queryPart += value;
                    }
                    queryParts.push(queryPart);
                }
            });
            
            const query = queryParts.join(' ');
            searchInput.value = query;
            searchInput.form.submit();
            closeModal();
        });
    }
});

// Clear search
function clearSearch() {
    const form = document.getElementById('searchForm');
    const searchInput = form.querySelector('input[name="q"]');
    searchInput.value = '';
    form.submit();
}

// Multi-column sorting
(function() {
    const currentSort = '{{ sort|escapejs }}';
    const sortLinks = document.querySelectorAll('.part-sort-link[data-field]');
    
    // Parse current sort state
    function parseSortState() {
        if (!currentSort) return [];
        return currentSort.split(',').map(s => s.trim()).filter(s => s);
    }
    
    // Update visual indicators
    function updateSortIndicators() {
        const sortFields = parseSortState();
        sortLinks.forEach(link => {
            const field = link.dataset.field;
            const indicator = link.querySelector('.sort-indicator');
            indicator.textContent = '';
            indicator.className = 'sort-indicator';
            link.classList.remove('active');
            
            for (let i = 0; i < sortFields.length; i++) {
                const sortField = sortFields[i];
                const isDesc = sortField.startsWith('-');
                const fieldName = isDesc ? sortField.substring(1) : sortField;
                
                if (fieldName === field) {
                    const priority = sortFields.length > 1 ? (i + 1) : '';
                    indicator.textContent = priority + (isDesc ? '↓' : '↑');
                    indicator.className = 'sort-indicator active';
                    link.classList.add('active');
                    break;
                }
            }
        });
    }
    
    // Handle sort link clicks
    sortLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const field = this.dataset.field;
            let sortFields = parseSortState();
            
            if (e.shiftKey) {
                // Shift+click: add/modify in multi-column sort
                let found = false;
                for (let i = 0; i < sortFields.length; i++) {
                    const sortField = sortFields[i];
                    const isDesc = sortField.startsWith('-');
                    const fieldName = isDesc ? sortField.substring(1) : sortField;
                    
                    if (fieldName === field) {
                        // Toggle direction
                        sortFields[i] = isDesc ? field : '-' + field;
                        found = true;
                        break;
                    }
                }
                if (!found) {
                    // Add new field
                    sortFields.push(field);
                }
            } else {
                // Regular click: replace all sorts with this field
                const currentField = sortFields.find(s => s === field || s === '-' + field);
                if (currentField) {
                    sortFields = [currentField.startsWith('-') ? field : '-' + field];
                } else {
                    sortFields = [field];
                }
            }
            
            // Build URL and navigate
            const url = new URL(window.location);
            url.searchParams.delete('page');
            url.searchParams.set('sort', sortFields.join(','));
            window.location.href = url.toString();
        });
    });
    
    // Initialize indicators
    updateSortIndicators();
})();
</script>
{% endblock %}
