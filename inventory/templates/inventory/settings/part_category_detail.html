{% extends 'base.html' %}
{% load static %}

{% block title %}{{ category.name }} - Fields - Settings - SGR Part Manager{% endblock %}

{% block extra_css %}
<style>
    .settings-header {
        background: linear-gradient(135deg, var(--gray-900) 0%, var(--gray-700) 100%);
        color: white;
        padding: 2rem;
        margin: -1rem -1rem 2rem -1rem;
        border-radius: var(--border-radius);
    }
    
    .settings-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .settings-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
    }
    
    .breadcrumb {
        font-size: 0.875rem;
        opacity: 0.8;
        margin-bottom: 1rem;
    }
    
    .breadcrumb a {
        color: white;
        text-decoration: none;
    }
    
    .breadcrumb a:hover {
        text-decoration: underline;
    }
    
    .category-header {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .category-name {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: 0.5rem;
    }
    
    .category-slug {
        color: var(--gray-500);
        font-family: monospace;
        font-size: 0.875rem;
    }
    
    .page-actions {
        margin-bottom: 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.15s ease-in-out;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-primary {
        background-color: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background-color: #0056b3;
    }
    
    .btn-outline-primary {
        background-color: transparent;
        color: #007bff;
        border: 1px solid #007bff;
    }
    
    .btn-outline-primary:hover {
        background-color: #007bff;
        color: white;
    }
    
    .btn-outline-danger {
        background-color: transparent;
        color: #dc3545;
        border: 1px solid #dc3545;
    }
    
    .btn-outline-danger:hover {
        background-color: #dc3545;
        color: white;
    }
    
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
    
    .fields-table {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius);
        overflow: hidden;
        margin-bottom: 2rem;
    }
    
    .fields-table table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .fields-table th {
        background: var(--gray-50);
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: var(--gray-700);
        border-bottom: 1px solid var(--gray-200);
    }
    
    .fields-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--gray-200);
        vertical-align: top;
    }
    
    .fields-table tr:hover {
        background: var(--gray-50);
    }
    
    .field-name {
        font-weight: 600;
        color: var(--gray-900);
    }
    
    .field-code {
        color: var(--gray-500);
        font-size: 0.875rem;
        font-family: monospace;
    }
    
    .data-type-badge {
        background: var(--blue-100);
        color: var(--blue-800);
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .required-badge {
        background: var(--red-100);
        color: var(--red-800);
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .table-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .choices-section {
        margin-top: 1rem;
        padding: 1rem;
        background: var(--gray-50);
        border-radius: 0.375rem;
        border: 1px solid var(--gray-200);
    }
    
    .choices-section h4 {
        margin-bottom: 0.75rem;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--gray-700);
    }
    
    .choices-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .choices-table th,
    .choices-table td {
        padding: 0.5rem;
        text-align: left;
        font-size: 0.8rem;
        border-bottom: 1px solid var(--gray-200);
    }
    
    .choices-table th {
        font-weight: 600;
        color: var(--gray-600);
    }
    
    .add-field-form {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .add-field-form h3 {
        margin-bottom: 1rem;
        color: var(--gray-900);
        font-size: 1.1rem;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-label {
        display: block;
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }
    
    .form-control {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--gray-300);
        border-radius: 0.375rem;
        font-size: 0.875rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .form-check {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .form-check-input {
        margin: 0;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--gray-500);
    }
    
    .empty-state h3 {
        margin-bottom: 1rem;
        color: var(--gray-700);
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-header">
    <div class="breadcrumb">
        <a href="{% url 'inventory:parts_list' %}">Parts</a> &gt; 
        <a href="{% url 'inventory:part_categories_list' %}">Settings</a> &gt; 
        {{ category.name }}
    </div>
    <h1 class="settings-title">{{ category.name }}</h1>
    <p class="settings-subtitle">Manage fields and choices for this category</p>
</div>

<div class="category-header">
    <div class="category-name">{{ category.name }}</div>
    <div class="category-slug">{{ category.slug }}</div>
</div>

<div class="page-actions">
    <h2>Fields</h2>
    <div>
        <a href="{% url 'inventory:part_category_edit' category.id %}" class="btn btn-outline-primary">
            Edit Category
        </a>
        <a href="{% url 'inventory:part_categories_list' %}" class="btn btn-secondary">
            Back to Categories
        </a>
    </div>
</div>

<!-- Add Field Form -->
<div class="add-field-form">
    <h3>Add New Field</h3>
    <form hx-post="{% url 'inventory:part_attribute_add' category.id %}"
          hx-target="body"
          hx-swap="innerHTML">
        {% csrf_token %}
        <div class="form-row">
            <div class="form-group">
                <label for="field-name" class="form-label">Field Name <span class="required">*</span></label>
                <input type="text" 
                       id="field-name" 
                       name="name" 
                       class="form-control"
                       required>
            </div>
            <div class="form-group">
                <label for="field-code" class="form-label">Code</label>
                <input type="text" 
                       id="field-code" 
                       name="code" 
                       class="form-control"
                       placeholder="Leave blank to auto-generate">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="field-data-type" class="form-label">Data Type <span class="required">*</span></label>
                <select id="field-data-type" name="data_type" class="form-control" required>
                    <option value="">-- Select Data Type --</option>
                    <option value="text">Text</option>
                    <option value="int">Integer</option>
                    <option value="dec">Decimal</option>
                    <option value="bool">Boolean</option>
                    <option value="date">Date</option>
                    <option value="choice">Choice</option>
                </select>
            </div>
            <div class="form-group">
                <label for="field-unit" class="form-label">Unit</label>
                <input type="text" 
                       id="field-unit" 
                       name="unit" 
                       class="form-control"
                       placeholder="e.g., mm, kg, V">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="field-sort-order" class="form-label">Sort Order</label>
                <input type="number" 
                       id="field-sort-order" 
                       name="sort_order" 
                       value="0"
                       class="form-control">
            </div>
            <div class="form-group">
                <div class="form-check">
                    <input type="checkbox" 
                           id="field-required" 
                           name="is_required" 
                           class="form-check-input">
                    <label for="field-required" class="form-label">Required Field</label>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label for="field-help-text" class="form-label">Help Text</label>
            <textarea id="field-help-text" 
                      name="help_text" 
                      class="form-control"
                      rows="2"
                      placeholder="Optional help text for users"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Add Field</button>
    </form>
</div>

<!-- Fields Table -->
<div class="fields-table">
    {% if attributes %}
        <table>
            <thead>
                <tr>
                    <th>Field Name</th>
                    <th>Code</th>
                    <th>Data Type</th>
                    <th>Unit</th>
                    <th>Required</th>
                    <th>Sort Order</th>
                    <th>Help Text</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for attribute in attributes %}
                    <tr>
                        <td>
                            <div class="field-name">{{ attribute.name }}</div>
                        </td>
                        <td>
                            <div class="field-code">{{ attribute.code }}</div>
                        </td>
                        <td>
                            <span class="data-type-badge">{{ attribute.get_data_type_display }}</span>
                        </td>
                        <td>{{ attribute.unit|default:"—" }}</td>
                        <td>
                            {% if attribute.is_required %}
                                <span class="required-badge">Required</span>
                            {% else %}
                                Optional
                            {% endif %}
                        </td>
                        <td>{{ attribute.sort_order }}</td>
                        <td>{{ attribute.help_text|default:"—" }}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-outline-primary btn-sm"
                                        onclick="editField({{ attribute.id }})">
                                    Edit
                                </button>
                                <button class="btn btn-outline-danger btn-sm"
                                        onclick="deleteField({{ attribute.id }}, '{{ attribute.name }}')">
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% if attribute.data_type == 'choice' and attribute.choices.exists %}
                        <tr>
                            <td colspan="8">
                                <div class="choices-section">
                                    <h4>Choices for {{ attribute.name }}</h4>
                                    <table class="choices-table">
                                        <thead>
                                            <tr>
                                                <th>Value</th>
                                                <th>Label</th>
                                                <th>Sort Order</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for choice in attribute.choices.all %}
                                                <tr>
                                                    <td>{{ choice.value }}</td>
                                                    <td>{{ choice.label }}</td>
                                                    <td>{{ choice.sort_order }}</td>
                                                    <td>
                                                        <div class="table-actions">
                                                            <button class="btn btn-outline-primary btn-sm"
                                                                    onclick="editChoice({{ attribute.id }}, {{ choice.id }})">
                                                                Edit
                                                            </button>
                                                            <button class="btn btn-outline-danger btn-sm"
                                                                    onclick="deleteChoice({{ attribute.id }}, {{ choice.id }}, '{{ choice.label }}')">
                                                                Delete
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    <button class="btn btn-outline-primary btn-sm"
                                            onclick="addChoice({{ attribute.id }})"
                                            style="margin-top: 0.5rem;">
                                        + Add Choice
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="empty-state">
            <h3>No Fields Yet</h3>
            <p>Add fields to this category to start collecting custom data for parts.</p>
        </div>
    {% endif %}
</div>

<script>
// Auto-generate code from name
document.getElementById('field-name').addEventListener('input', function() {
    const codeField = document.getElementById('field-code');
    if (codeField.value === '') {
        const name = this.value.toLowerCase()
            .replace(/[^a-z0-9\s-]/g, '')
            .replace(/\s+/g, '_')
            .replace(/_+/g, '_')
            .trim('_');
        codeField.value = name;
    }
});

function editField(attributeId) {
    // TODO: Implement edit field modal/form
    alert('Edit field functionality coming soon');
}

function deleteField(attributeId, fieldName) {
    if (confirm(`Are you sure you want to delete the field "${fieldName}"?\n\nThis action cannot be undone.`)) {
        fetch(`/inventory/settings/parts/categories/{{ category.id }}/attributes/${attributeId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        }).then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                response.text().then(text => {
                    alert('Error: ' + text);
                });
            }
        });
    }
}

function addChoice(attributeId) {
    // TODO: Implement add choice modal/form
    alert('Add choice functionality coming soon');
}

function editChoice(attributeId, choiceId) {
    // TODO: Implement edit choice modal/form
    alert('Edit choice functionality coming soon');
}

function deleteChoice(attributeId, choiceId, choiceLabel) {
    if (confirm(`Are you sure you want to delete the choice "${choiceLabel}"?\n\nThis action cannot be undone.`)) {
        fetch(`/inventory/settings/parts/categories/{{ category.id }}/attributes/${attributeId}/choices/${choiceId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        }).then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                response.text().then(text => {
                    alert('Error: ' + text);
                });
            }
        });
    }
}
</script>
{% endblock %}
