{% extends "base.html" %}

{% block extra_css %}
<style>
    .contacts-section {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid #e5e7eb;
    }
    
    .contacts-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .contacts-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
    }
    
    .contacts-table th,
    .contacts-table td {
        padding: 0.5rem;
        border: 1px solid #e5e7eb;
        text-align: left;
    }
    
    .contacts-table th {
        background-color: #f9fafb;
        font-weight: 600;
    }
    
    .contacts-table input,
    .contacts-table textarea {
        width: 100%;
        border: 1px solid #d1d5db;
        padding: 0.25rem;
        border-radius: 4px;
    }
    
    .contacts-table textarea {
        resize: vertical;
        min-height: 2rem;
    }
    
    .remove-contact {
        background: #dc2626;
        color: white;
        border: none;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .remove-contact:hover {
        background: #b91c1c;
    }
    
    .add-contact-btn {
        background: #16a34a;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .add-contact-btn:hover {
        background: #15803d;
    }
    
    .formset-row {
        position: relative;
    }
    
    .formset-row.deleted {
        opacity: 0.5;
        background-color: #f3f4f6;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ is_create|yesno:"Add Vendor,Edit Vendor" }}</h1>
    <div class="page-actions">
        <a href="{% if is_create %}{% url 'inventory:vendor_index' %}{% else %}{% url 'inventory:vendor_detail' vendor.id %}{% endif %}" class="btn btn-secondary">Cancel</a>
    </div>
</div>

<div class="form-container">
    <form method="post" class="form" id="vendor-form">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
            <div class="alert alert-error">
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}
        
        <div class="form-grid">
            <div class="form-group">
                <label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                {{ form.name }}
                {% if form.name.errors %}
                    <div class="field-error">{{ form.name.errors.0 }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.website.id_for_label }}">{{ form.website.label }}</label>
                {{ form.website }}
                {% if form.website.errors %}
                    <div class="field-error">{{ form.website.errors.0 }}</div>
                {% endif %}
            </div>
            
            <div class="form-group full-width">
                <label for="{{ form.address.id_for_label }}">{{ form.address.label }}</label>
                {{ form.address }}
                {% if form.address.errors %}
                    <div class="field-error">{{ form.address.errors.0 }}</div>
                {% endif %}
            </div>
            
            <div class="form-group full-width">
                <label for="{{ form.notes.id_for_label }}">{{ form.notes.label }}</label>
                {{ form.notes }}
                {% if form.notes.errors %}
                    <div class="field-error">{{ form.notes.errors.0 }}</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Contacts Section -->
        <div class="contacts-section">
            <div class="contacts-header">
                <h2>Contacts</h2>
                <button type="button" class="add-contact-btn" onclick="addContact()">Add Contact</button>
            </div>
            
            {{ formset.management_form }}
            
            <table class="contacts-table">
                <thead>
                    <tr>
                        <th>Full Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Title</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="contacts-tbody">
                    {% for contact_form in formset %}
                        <tr class="formset-row" data-form-index="{{ forloop.counter0 }}">
                            <td>
                                {{ contact_form.full_name }}
                                {% if contact_form.full_name.errors %}
                                    <div class="field-error">{{ contact_form.full_name.errors.0 }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {{ contact_form.email }}
                                {% if contact_form.email.errors %}
                                    <div class="field-error">{{ contact_form.email.errors.0 }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {{ contact_form.phone }}
                                {% if contact_form.phone.errors %}
                                    <div class="field-error">{{ contact_form.phone.errors.0 }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {{ contact_form.title }}
                                {% if contact_form.title.errors %}
                                    <div class="field-error">{{ contact_form.title.errors.0 }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {{ contact_form.notes }}
                                {% if contact_form.notes.errors %}
                                    <div class="field-error">{{ contact_form.notes.errors.0 }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {% if contact_form.DELETE %}
                                    {{ contact_form.DELETE }}
                                    <button type="button" class="remove-contact" onclick="removeContact(this)">Remove</button>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                {{ is_create|yesno:"Create Vendor,Update Vendor" }}
            </button>
            <a href="{% if is_create %}{% url 'inventory:vendor_index' %}{% else %}{% url 'inventory:vendor_detail' vendor.id %}{% endif %}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let totalForms = parseInt(document.querySelector('#id_contacts-TOTAL_FORMS').value);
    
    function addContact() {
        const tbody = document.getElementById('contacts-tbody');
        const newRow = document.createElement('tr');
        newRow.className = 'formset-row';
        newRow.setAttribute('data-form-index', totalForms);
        
        newRow.innerHTML = `
            <td>
                <input type="text" name="contacts-${totalForms}-full_name" maxlength="120" id="id_contacts-${totalForms}-full_name">
            </td>
            <td>
                <input type="email" name="contacts-${totalForms}-email" id="id_contacts-${totalForms}-email">
            </td>
            <td>
                <input type="text" name="contacts-${totalForms}-phone" maxlength="50" id="id_contacts-${totalForms}-phone">
            </td>
            <td>
                <input type="text" name="contacts-${totalForms}-title" maxlength="120" id="id_contacts-${totalForms}-title">
            </td>
            <td>
                <textarea name="contacts-${totalForms}-notes" id="id_contacts-${totalForms}-notes" rows="2"></textarea>
            </td>
            <td>
                <input type="checkbox" name="contacts-${totalForms}-DELETE" id="id_contacts-${totalForms}-DELETE" style="display: none;">
                <button type="button" class="remove-contact" onclick="removeContact(this)">Remove</button>
            </td>
        `;
        
        tbody.appendChild(newRow);
        totalForms++;
        document.querySelector('#id_contacts-TOTAL_FORMS').value = totalForms;
    }
    
    function removeContact(button) {
        const row = button.closest('tr');
        const deleteCheckbox = row.querySelector('input[type="checkbox"][name*="-DELETE"]');
        
        if (deleteCheckbox) {
            // Existing row - mark for deletion
            deleteCheckbox.checked = true;
            row.classList.add('deleted');
            button.style.display = 'none';
        } else {
            // New row - remove completely
            row.remove();
        }
    }
</script>
{% endblock %}

