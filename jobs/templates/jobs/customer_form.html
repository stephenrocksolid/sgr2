{% extends "base.html" %}
{% load static %}

{% block title %}{% if is_new %}New Customer{% else %}{{ customer.name|default:"Customer" }}{% endif %} - Spring Garden Repair{% endblock %}

{% block content %}
<div class="customer-page">
    <!-- Sticky Header -->
    <div class="customer-header">
        <div class="customer-header-left">
            <div class="customer-name-display">
                <span class="customer-label">Customer</span>
                <h1 class="customer-name-title">{% if is_new %}New Customer{% else %}{{ customer.name|default:"(No Name)" }}{% endif %}</h1>
            </div>
            {% if not is_new and customer.jobs.count > 0 %}
            <span class="customer-jobs-badge">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                </svg>
                {{ customer.jobs.count }} Job{{ customer.jobs.count|pluralize }}
            </span>
            {% endif %}
        </div>
        <div class="customer-header-actions">
            <button type="button" class="btn btn-primary" onclick="document.getElementById('customer-form').requestSubmit()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                {% if is_new %}Create Customer{% else %}Save Changes{% endif %}
            </button>
            <a href="{% url 'jobs:customer_list' %}" class="btn btn-outline">Cancel</a>
            {% if not is_new %}
            <button type="button" class="btn btn-danger-outline" 
                    onclick="confirmDelete()"
                    {% if customer.jobs.exists %}disabled title="Cannot delete customer with jobs"{% endif %}>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Delete
            </button>
            {% endif %}
        </div>
    </div>

    <form method="post" id="customer-form">
        {% csrf_token %}
        
        <div class="customer-layout">
            <!-- Main Content Column -->
            <div class="customer-main">
                <!-- Basic Information Card -->
                <div class="customer-card">
                    <div class="customer-card-header">
                        <div class="customer-card-title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            Basic Information
                        </div>
                    </div>
                    <div class="customer-card-body">
                        <div class="customer-form-grid">
                            <div class="customer-form-group customer-form-full">
                                <label class="customer-label">Customer Name</label>
                                <input type="text" name="name" value="{{ form.name.value|default_if_none:'' }}" class="customer-input" placeholder="Enter customer name">
                                {% if form.name.errors %}<span class="field-error">{{ form.name.errors.0 }}</span>{% endif %}
                            </div>
                            <div class="customer-form-group">
                                <label class="customer-label">Email</label>
                                <input type="email" name="email" value="{{ form.email.value|default_if_none:'' }}" class="customer-input" placeholder="email@example.com">
                                {% if form.email.errors %}<span class="field-error">{{ form.email.errors.0 }}</span>{% endif %}
                            </div>
                            <div class="customer-form-group">
                                <label class="customer-label">Phone</label>
                                <input type="text" name="phone" value="{{ form.phone.value|default_if_none:'' }}" class="customer-input" placeholder="(555) 123-4567">
                                {% if form.phone.errors %}<span class="field-error">{{ form.phone.errors.0 }}</span>{% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bill To Address Card -->
                <div class="customer-card">
                    <div class="customer-card-header">
                        <div class="customer-card-title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                <line x1="1" y1="10" x2="23" y2="10"></line>
                            </svg>
                            Bill To Address
                        </div>
                    </div>
                    <div class="customer-card-body">
                        <div class="customer-form-grid customer-form-grid-3">
                            <div class="customer-form-group customer-form-full">
                                <label class="customer-label">Company/Name</label>
                                <input type="text" name="bill_to_name" value="{{ form.bill_to_name.value|default_if_none:'' }}" class="customer-input" placeholder="Billing name">
                            </div>
                            <div class="customer-form-group customer-form-full">
                                <label class="customer-label">Street Address</label>
                                <input type="text" name="bill_to_address" value="{{ form.bill_to_address.value|default_if_none:'' }}" class="customer-input" placeholder="123 Main St">
                            </div>
                            <div class="customer-form-group">
                                <label class="customer-label">City</label>
                                <input type="text" name="bill_to_city" value="{{ form.bill_to_city.value|default_if_none:'' }}" class="customer-input" placeholder="City">
                            </div>
                            <div class="customer-form-group">
                                <label class="customer-label">State</label>
                                <input type="text" name="bill_to_state" value="{{ form.bill_to_state.value|default_if_none:'' }}" class="customer-input" placeholder="PA">
                            </div>
                            <div class="customer-form-group">
                                <label class="customer-label">ZIP</label>
                                <input type="text" name="bill_to_zip" value="{{ form.bill_to_zip.value|default_if_none:'' }}" class="customer-input" placeholder="12345">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ship To Addresses Card -->
                {% if not is_new %}
                <div class="customer-card">
                    <div class="customer-card-header">
                        <div class="customer-card-title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="1" y="3" width="15" height="13"></rect>
                                <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                                <circle cx="5.5" cy="18.5" r="2.5"></circle>
                                <circle cx="18.5" cy="18.5" r="2.5"></circle>
                            </svg>
                            Ship To Addresses
                            <span class="customer-badge-count">{{ ship_to_addresses.count }}</span>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary"
                                hx-get="{% url 'jobs:customer_ship_to_create_modal' customer.pk %}"
                                hx-target="body"
                                hx-swap="beforeend">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Add Address
                        </button>
                    </div>
                    <div class="customer-card-body p-0">
                        <div id="ship-to-addresses">
                            {% include 'jobs/partials/customer_ship_to_table.html' %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Sidebar Column -->
            <div class="customer-sidebar">
                <!-- Default Pricing & Terms Card -->
                <div class="customer-card">
                    <div class="customer-card-header">
                        <div class="customer-card-title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                            Default Pricing & Terms
                        </div>
                    </div>
                    <div class="customer-card-body">
                        <div class="customer-form-group">
                            <label class="customer-label-sm">Price Setting</label>
                            <select name="default_price_setting" class="customer-select">
                                <option value="">Select...</option>
                                <option value="list" {% if form.default_price_setting.value == 'list' %}selected{% endif %}>List</option>
                                <option value="jobber" {% if form.default_price_setting.value == 'jobber' %}selected{% endif %}>Jobber</option>
                            </select>
                            <p class="customer-field-hint">Applied to new jobs by default</p>
                        </div>
                        <div class="customer-form-group">
                            <label class="customer-label-sm">Payment Terms</label>
                            <select name="default_terms" class="customer-select">
                                <option value="">Select...</option>
                                <option value="net_30" {% if form.default_terms.value == 'net_30' %}selected{% endif %}>Net 30</option>
                                <option value="1pct_10" {% if form.default_terms.value == '1pct_10' %}selected{% endif %}>1% 10</option>
                                <option value="other" {% if form.default_terms.value == 'other' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                    </div>
                </div>

                {% if not is_new %}
                <!-- Quick Info Card -->
                <div class="customer-card">
                    <div class="customer-card-header">
                        <div class="customer-card-title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="16" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12.01" y2="8"></line>
                            </svg>
                            Quick Info
                        </div>
                    </div>
                    <div class="customer-card-body">
                        <div class="customer-quick-info">
                            <div class="customer-info-row">
                                <span class="customer-info-label">Total Jobs</span>
                                <span class="customer-info-value">{{ customer.jobs.count }}</span>
                            </div>
                            <div class="customer-info-row">
                                <span class="customer-info-label">Ship-To Addresses</span>
                                <span class="customer-info-value">{{ ship_to_addresses.count }}</span>
                            </div>
                            <div class="customer-info-row">
                                <span class="customer-info-label">Created</span>
                                <span class="customer-info-value">{{ customer.created_at|date:"M d, Y" }}</span>
                            </div>
                            {% if customer.updated_at %}
                            <div class="customer-info-row">
                                <span class="customer-info-label">Last Updated</span>
                                <span class="customer-info-value">{{ customer.updated_at|date:"M d, Y" }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </form>

    {% if not is_new %}
    <!-- Delete form (hidden) -->
    <form method="post" action="{% url 'jobs:customer_delete' customer.pk %}" id="delete-form" style="display: none;">
        {% csrf_token %}
    </form>
    {% endif %}
</div>

<style>
/* Customer Page Layout */
.customer-page {
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 1rem;
}

/* Sticky Header */
.customer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 1rem 1.5rem;
    margin: -2rem -1rem 1.5rem -1rem;
    border-bottom: 1px solid var(--gray-200);
    position: sticky;
    top: 0;
    z-index: 50;
    box-shadow: var(--shadow-sm);
}

.customer-header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.customer-name-display {
    display: flex;
    flex-direction: column;
}

.customer-name-display .customer-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--gray-500);
    font-weight: 600;
}

.customer-name-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--gray-900);
    margin: 0;
    line-height: 1.2;
}

.customer-jobs-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.375rem 0.75rem;
    background: var(--gray-100);
    color: var(--gray-700);
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
}

.customer-header-actions {
    display: flex;
    gap: 0.75rem;
}

.customer-header-actions .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

/* Two Column Layout */
.customer-layout {
    display: grid;
    grid-template-columns: 1fr 340px;
    gap: 1.5rem;
    align-items: start;
}

.customer-main {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.customer-sidebar {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    position: sticky;
    top: 90px;
}

/* Card Styles */
.customer-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: 0.5rem;
    box-shadow: var(--shadow-sm);
    overflow: hidden;
}

.customer-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.875rem 1.25rem;
    background: var(--gray-50);
    border-bottom: 1px solid var(--gray-200);
}

.customer-card-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--gray-700);
}

.customer-card-title svg {
    color: var(--gray-500);
}

.customer-card-body {
    padding: 1.25rem;
}

.customer-card-body.p-0 {
    padding: 0;
}

/* Form Elements */
.customer-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.customer-form-grid-3 {
    grid-template-columns: 1fr 1fr 1fr;
}

.customer-form-group {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
    margin-bottom: 0;
}

.customer-form-full {
    grid-column: 1 / -1;
}

.customer-form-half {
    grid-column: span 1;
}

.customer-label,
.customer-label-sm {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--gray-600);
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.customer-input,
.customer-select {
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--gray-300);
    border-radius: 0.375rem;
    font-size: 0.875rem;
    color: var(--gray-900);
    background: white;
    transition: all 0.15s ease;
    width: 100%;
}

.customer-input:focus,
.customer-select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(74, 85, 104, 0.1);
}

.customer-input::placeholder {
    color: var(--gray-400);
}

.customer-field-hint {
    font-size: 0.75rem;
    color: var(--gray-500);
    margin: 0.25rem 0 0;
}

.field-error {
    font-size: 0.75rem;
    color: var(--error);
    margin-top: 0.25rem;
}

/* Badge Count */
.customer-badge-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 20px;
    height: 20px;
    padding: 0 0.375rem;
    background: var(--gray-200);
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--gray-600);
}

/* Quick Info */
.customer-quick-info {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.customer-info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--gray-100);
}

.customer-info-row:last-child {
    border-bottom: none;
}

.customer-info-label {
    font-size: 0.8125rem;
    color: var(--gray-600);
}

.customer-info-value {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--gray-900);
}

/* Button Variants */
.btn-outline {
    background: white;
    color: var(--gray-700);
    border: 1px solid var(--gray-300);
}

.btn-outline:hover {
    background: var(--gray-50);
    border-color: var(--gray-400);
}

.btn-danger-outline {
    background: white;
    color: var(--error);
    border: 1px solid var(--gray-300);
}

.btn-danger-outline:hover:not(:disabled) {
    background: #fef2f2;
    border-color: var(--error);
}

.btn-danger-outline:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Responsive */
@media (max-width: 1024px) {
    .customer-layout {
        grid-template-columns: 1fr;
    }
    
    .customer-sidebar {
        position: static;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
    }
}

@media (max-width: 900px) {
    .customer-form-grid-3 {
        grid-template-columns: 1fr 1fr;
    }
}

@media (max-width: 768px) {
    .customer-sidebar {
        grid-template-columns: 1fr;
    }
    
    .customer-form-grid,
    .customer-form-grid-3 {
        grid-template-columns: 1fr;
    }
    
    .customer-form-half {
        grid-column: span 1;
    }
}

@media (max-width: 640px) {
    .customer-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .customer-header-left {
        flex-wrap: wrap;
    }
    
    .customer-header-actions {
        flex-wrap: wrap;
    }
}
</style>

<script>
{% if not is_new %}
function confirmDelete() {
    {% if customer.jobs.exists %}
    alert('Cannot delete this customer because they have associated jobs.');
    {% else %}
    if(confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {
        document.getElementById('delete-form').submit();
    }
    {% endif %}
}
{% endif %}
</script>
{% endblock %}

