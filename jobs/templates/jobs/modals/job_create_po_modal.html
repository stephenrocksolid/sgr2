<!-- Modal for Creating PO from Job Parts -->
<div class="po-modal-overlay" id="create-po-modal" onclick="if(event.target === this) this.remove()">
    <div class="po-modal po-modal-lg" onclick="event.stopPropagation()">
        <div class="po-modal-header">
            <div class="po-modal-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="12" y1="18" x2="12" y2="12"></line>
                    <line x1="9" y1="15" x2="15" y2="15"></line>
                </svg>
                Create Purchase Order
            </div>
            <button type="button" class="po-modal-close" onclick="document.getElementById('create-po-modal').remove()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <div class="po-modal-body">
            {% if no_parts_selected %}
            <div class="po-create-empty">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                <h3>No Parts Selected</h3>
                <p>Please select at least one part using the checkboxes in the Parts table before creating a Purchase Order.</p>
                <button type="button" class="btn btn-primary" onclick="document.getElementById('create-po-modal').remove()">Got it</button>
            </div>
            {% elif error %}
            <div class="po-create-empty po-create-error">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                <h3>Error</h3>
                <p>{{ error }}</p>
                <button type="button" class="btn btn-primary" onclick="document.getElementById('create-po-modal').remove()">Close</button>
            </div>
            {% else %}
            <form id="create-po-form" 
                  hx-post="{% url 'jobs:job_create_po' job.pk %}"
                  hx-target="#job-parts-section"
                  hx-swap="outerHTML"
                  hx-on::after-request="if(event.detail.successful) { document.getElementById('create-po-modal').remove(); htmx.trigger(document.body, 'poCreated'); }">
                {% csrf_token %}
                
                <div class="po-create-content">
                    <div class="po-create-section">
                        <div class="po-create-section-header">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                            </svg>
                            Select Vendor
                        </div>
                        <div class="po-create-vendor-select">
                            <select name="vendor_id" id="vendor-select" class="po-form-select" required onchange="updateExistingPO()">
                                <option value="">Choose a vendor...</option>
                                {% for vendor in all_vendors %}
                                <option value="{{ vendor.pk }}" {% if parts_by_vendor and vendor.pk in parts_by_vendor %}selected{% endif %}>{{ vendor.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div id="existing-po-option" class="po-create-existing" style="display: none;">
                            <label class="po-create-existing-label">
                                <input type="checkbox" name="use_existing_po" id="use-existing-po" onchange="toggleExistingPO()">
                                <span class="po-create-existing-text">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                    </svg>
                                    Add to existing draft PO: <strong id="existing-po-number"></strong>
                                </span>
                            </label>
                            <input type="hidden" name="existing_po_id" id="existing-po-id" value="">
                        </div>
                    </div>
                    
                    <div class="po-create-section">
                        <div class="po-create-section-header">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"></path>
                            </svg>
                            Selected Parts ({{ selected_parts.count }})
                        </div>
                        
                        <div class="po-create-parts-list">
                            {% for jpart in selected_parts %}
                            <div class="po-create-part-item">
                                <div class="po-create-part-checkbox">
                                    <input type="checkbox" name="part_ids" value="{{ jpart.pk }}" checked id="part-{{ jpart.pk }}">
                                </div>
                                <div class="po-create-part-info">
                                    <label for="part-{{ jpart.pk }}" class="po-create-part-name">
                                        <code class="po-create-part-number">{{ jpart.part_number }}</code>
                                        {{ jpart.name }}
                                    </label>
                                    {% if jpart.source_part and jpart.source_part.primary_vendor %}
                                    <span class="po-create-part-vendor">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                        </svg>
                                        {{ jpart.source_part.primary_vendor.name }}
                                    </span>
                                    {% else %}
                                    <span class="po-create-part-vendor po-create-no-vendor">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="12" y1="8" x2="12" y2="12"></line>
                                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                        </svg>
                                        No primary vendor
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="po-create-part-qty">
                                    <label class="po-create-qty-label">Qty</label>
                                    <input type="number" name="qty_{{ jpart.pk }}" value="{{ jpart.quantity|floatformat:0 }}" min="1" step="1" class="po-create-qty-input">
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="po-modal-footer">
                    <button type="button" class="btn btn-outline" onclick="document.getElementById('create-po-modal').remove()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="12" y1="18" x2="12" y2="12"></line>
                            <line x1="9" y1="15" x2="15" y2="15"></line>
                        </svg>
                        <span id="submit-btn-text">Create Purchase Order</span>
                    </button>
                </div>
            </form>
            {% endif %}
        </div>
    </div>
</div>

<script>
const vendorDraftPOs = {
    {% for vid, vdata in parts_by_vendor.items %}{% if vdata.existing_draft_po %}'{{ vid }}': { id: '{{ vdata.existing_draft_po.pk }}', number: '{{ vdata.existing_draft_po.po_number }}' },{% endif %}{% endfor %}
};

function updateExistingPO() {
    const vendorId = document.getElementById('vendor-select').value;
    const existingOption = document.getElementById('existing-po-option');
    const existingPoId = document.getElementById('existing-po-id');
    const existingPoNumber = document.getElementById('existing-po-number');
    const useExistingCheckbox = document.getElementById('use-existing-po');
    
    if (vendorId && vendorDraftPOs[vendorId]) {
        existingOption.style.display = 'block';
        existingPoNumber.textContent = vendorDraftPOs[vendorId].number;
        existingPoId.value = vendorDraftPOs[vendorId].id;
        useExistingCheckbox.checked = true;
        toggleExistingPO();
    } else {
        existingOption.style.display = 'none';
        existingPoId.value = '';
        useExistingCheckbox.checked = false;
        toggleExistingPO();
    }
}

function toggleExistingPO() {
    const useExisting = document.getElementById('use-existing-po').checked;
    const submitText = document.getElementById('submit-btn-text');
    const existingPoId = document.getElementById('existing-po-id');
    
    if (useExisting && existingPoId.value) {
        submitText.textContent = 'Add to Existing PO';
    } else {
        submitText.textContent = 'Create Purchase Order';
        if (!useExisting) existingPoId.value = '';
    }
}

updateExistingPO();
</script>

<style>
.po-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); display: flex; align-items: center; justify-content: center; z-index: 9999; animation: poModalFadeIn 0.2s ease-out; }
@keyframes poModalFadeIn { from { opacity: 0; } to { opacity: 1; } }
.po-modal { background: white; border-radius: 0.75rem; width: 90%; max-width: 600px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); animation: poModalSlideIn 0.2s ease-out; }
.po-modal-lg { max-width: 700px; }
@keyframes poModalSlideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
.po-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--gray-200); flex-shrink: 0; }
.po-modal-title { display: flex; align-items: center; gap: 0.625rem; font-size: 1.125rem; font-weight: 600; color: var(--gray-900); }
.po-modal-title svg { color: var(--gray-500); }
.po-modal-close { display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; padding: 0; background: transparent; border: none; border-radius: 0.375rem; color: var(--gray-400); cursor: pointer; transition: all 0.15s ease; }
.po-modal-close:hover { background: var(--gray-100); color: var(--gray-600); }
.po-modal-body { flex: 1; overflow-y: auto; padding: 0; }
.po-modal-footer { display: flex; justify-content: flex-end; gap: 0.75rem; padding: 1rem 1.5rem; border-top: 1px solid var(--gray-200); background: var(--gray-50); flex-shrink: 0; }
.po-create-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem 2rem; text-align: center; }
.po-create-empty svg { color: var(--gray-300); margin-bottom: 1rem; }
.po-create-empty h3 { margin: 0 0 0.5rem 0; font-size: 1.125rem; font-weight: 600; color: var(--gray-900); }
.po-create-empty p { margin: 0 0 1.5rem 0; color: var(--gray-600); max-width: 320px; }
.po-create-error svg { color: #ef4444; }
.po-create-content { padding: 1.5rem; }
.po-create-section { margin-bottom: 1.5rem; }
.po-create-section:last-child { margin-bottom: 0; }
.po-create-section-header { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 600; color: var(--gray-700); margin-bottom: 0.75rem; }
.po-create-section-header svg { color: var(--gray-400); }
.po-create-vendor-select { margin-bottom: 0.75rem; }
.po-form-select { width: 100%; padding: 0.625rem 0.875rem; border: 1px solid var(--gray-300); border-radius: 0.375rem; font-size: 0.875rem; background: white; cursor: pointer; transition: all 0.15s ease; }
.po-form-select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(74, 85, 104, 0.1); }
.po-create-existing { background: #eff6ff; border: 1px solid #93c5fd; border-radius: 0.375rem; padding: 0.75rem; }
.po-create-existing-label { display: flex; align-items: center; gap: 0.625rem; cursor: pointer; }
.po-create-existing-label input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary); }
.po-create-existing-text { display: flex; align-items: center; gap: 0.375rem; font-size: 0.875rem; color: #1e40af; }
.po-create-existing-text svg { color: #3b82f6; }
.po-create-parts-list { border: 1px solid var(--gray-200); border-radius: 0.375rem; overflow: hidden; }
.po-create-part-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-bottom: 1px solid var(--gray-200); background: white; }
.po-create-part-item:last-child { border-bottom: none; }
.po-create-part-item:hover { background: var(--gray-50); }
.po-create-part-checkbox input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary); cursor: pointer; }
.po-create-part-info { flex: 1; min-width: 0; }
.po-create-part-name { display: block; font-size: 0.875rem; color: var(--gray-900); cursor: pointer; margin-bottom: 0.25rem; }
.po-create-part-number { display: inline-block; padding: 0.125rem 0.375rem; background: var(--gray-100); border-radius: 0.25rem; font-size: 0.75rem; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; color: var(--gray-700); margin-right: 0.5rem; }
.po-create-part-vendor { display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: var(--gray-500); }
.po-create-part-vendor svg { color: var(--gray-400); }
.po-create-no-vendor { color: #f59e0b; }
.po-create-no-vendor svg { color: #f59e0b; }
.po-create-part-qty { display: flex; flex-direction: column; align-items: flex-end; gap: 0.25rem; }
.po-create-qty-label { font-size: 0.6875rem; font-weight: 600; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.025em; }
.po-create-qty-input { width: 70px; padding: 0.375rem 0.5rem; border: 1px solid var(--gray-300); border-radius: 0.25rem; font-size: 0.875rem; text-align: center; }
.po-create-qty-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(74, 85, 104, 0.1); }
.btn { display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500; border-radius: 0.375rem; cursor: pointer; transition: all 0.15s ease; }
.btn-primary { background: var(--primary); color: white; border: none; }
.btn-primary:hover { background: var(--primary-dark, #374151); }
.btn-outline { background: white; color: var(--gray-700); border: 1px solid var(--gray-300); }
.btn-outline:hover { background: var(--gray-50); border-color: var(--gray-400); }
</style>

