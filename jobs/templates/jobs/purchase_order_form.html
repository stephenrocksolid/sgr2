{% extends "base.html" %}
{% load static %}

{% block title %}PO {{ po.po_number }} - Spring Garden Repair{% endblock %}

{% block content %}
<div class="po-page">
    <!-- Sticky Header -->
    <div class="po-header">
        <div class="po-header-left">
            <div class="po-number-display">
                <span class="po-label">Purchase Order</span>
                <h1 class="po-number">{{ po.po_number }}</h1>
            </div>
            <span id="po-status-badge" class="po-status-badge po-status-{{ po.status }}">{{ po.get_status_display }}</span>
            {% if po.is_urgent %}
            <span class="po-urgent-badge">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                Urgent
            </span>
            {% endif %}
        </div>
        <div class="po-header-actions">
            <button type="button" class="btn btn-primary" onclick="document.getElementById('po-form').requestSubmit()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                Save Changes
            </button>
            <a href="{% url 'jobs:purchase_order_list' %}" class="btn btn-outline">Cancel</a>
            <button type="button" class="btn btn-danger-outline" 
                    onclick="if(confirm('Are you sure you want to delete this Purchase Order? This action cannot be undone.')) document.getElementById('delete-form').submit()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Delete
            </button>
        </div>
    </div>

    <form method="post" id="po-form">
        {% csrf_token %}
        
        <div class="po-layout">
            <!-- Main Content Column -->
            <div class="po-main">
                <!-- Vendor & Ship To Row (side by side) -->
                <div class="po-two-column-row">
                    <!-- Vendor Card -->
                    <div class="po-card">
                        <div class="po-card-header">
                            <div class="po-card-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                </svg>
                                Vendor
                            </div>
                        </div>
                        <div class="po-card-body">
                            <div id="vendor-section">
                                {% include 'jobs/partials/po_vendor_selected_section.html' %}
                            </div>
                            <div class="po-form-row mt-lg">
                                <div class="po-form-group">
                                    <label class="po-label-sm">Vendor Contact</label>
                                    <select name="vendor_contact" class="po-select">
                                        <option value="">Select contact...</option>
                                        {% for contact in vendor_contacts %}
                                        <option value="{{ contact.id }}" {% if po.vendor_contact_id == contact.id %}selected{% endif %}>
                                            {{ contact.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="po-form-group">
                                    <label class="po-label-sm">Vendor PO Number</label>
                                    <input type="text" name="vendor_po_number" value="{{ po.vendor_po_number|default_if_none:'' }}" class="po-input" placeholder="Vendor's reference #">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Shipping Address Card -->
                    <div class="po-card">
                        <div class="po-card-header">
                            <div class="po-card-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="1" y="3" width="15" height="13"></rect>
                                    <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                                    <circle cx="5.5" cy="18.5" r="2.5"></circle>
                                    <circle cx="18.5" cy="18.5" r="2.5"></circle>
                                </svg>
                                Ship To Address
                            </div>
                            <div class="po-ship-to-actions">
                                <button type="button" class="po-ship-to-btn" onclick="useDefaultAddress()">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                    </svg>
                                    Use Default
                                </button>
                                <button type="button" class="po-ship-to-btn"
                                        hx-get="{% url 'jobs:po_customer_search_modal' po.pk %}"
                                        hx-target="body"
                                        hx-swap="beforeend">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                    </svg>
                                    Search Customer
                                </button>
                            </div>
                        </div>
                        <div class="po-card-body">
                            <div class="po-form-row mb-sm">
                                <div class="po-form-group po-form-group-2">
                                    <label class="po-label-sm">Recipient Name</label>
                                    <input type="text" name="ship_to_name" id="ship_to_name" value="{{ po.ship_to_name|default_if_none:'' }}" class="po-input" placeholder="Company or person name">
                                </div>
                                <div class="po-form-group">
                                    <label class="po-label-sm">Phone</label>
                                    <input type="text" name="ship_to_phone" id="ship_to_phone" value="{{ po.ship_to_phone|default_if_none:'' }}" class="po-input" placeholder="(555) 123-4567">
                                </div>
                            </div>
                            <div class="po-form-row mb-sm">
                                <div class="po-form-group po-form-group-2">
                                    <label class="po-label-sm">Street Address</label>
                                    <input type="text" name="ship_to_address" id="ship_to_address" value="{{ po.ship_to_address|default_if_none:'' }}" class="po-input" placeholder="123 Main St">
                                </div>
                                <div class="po-form-group">
                                    <label class="po-label-sm">City</label>
                                    <input type="text" name="ship_to_city" id="ship_to_city" value="{{ po.ship_to_city|default_if_none:'' }}" class="po-input">
                                </div>
                            </div>
                            <div class="po-form-row">
                                <div class="po-form-group">
                                    <label class="po-label-sm">State</label>
                                    <input type="text" name="ship_to_state" id="ship_to_state" value="{{ po.ship_to_state|default_if_none:'' }}" class="po-input" placeholder="PA">
                                </div>
                                <div class="po-form-group">
                                    <label class="po-label-sm">ZIP Code</label>
                                    <input type="text" name="ship_to_zip" id="ship_to_zip" value="{{ po.ship_to_zip|default_if_none:'' }}" class="po-input">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Line Items Card -->
                <div class="po-card">
                    <div class="po-card-header">
                        <div class="po-card-title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="8" y1="6" x2="21" y2="6"></line>
                                <line x1="8" y1="12" x2="21" y2="12"></line>
                                <line x1="8" y1="18" x2="21" y2="18"></line>
                                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                                <line x1="3" y1="18" x2="3.01" y2="18"></line>
                            </svg>
                            Line Items
                        </div>
                        <button type="button" class="btn btn-sm btn-primary"
                                hx-get="{% url 'jobs:po_item_add_modal' po.pk %}"
                                hx-target="body"
                                hx-swap="beforeend">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Add Item
                        </button>
                    </div>
                    <div class="po-card-body p-0">
                        <div id="po-items-section">
                            {% include 'jobs/partials/po_items_table.html' %}
                        </div>
                    </div>
                </div>

                <!-- Notes Card -->
                <div class="po-card">
                    <div class="po-card-header">
                        <div class="po-card-title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            Notes
                        </div>
                    </div>
                    <div class="po-card-body">
                        <div class="po-notes-grid">
                            <div class="po-form-group">
                                <label class="po-label-sm">Internal Notes</label>
                                <textarea name="notes" class="po-textarea" rows="3" placeholder="Private notes (not visible to vendor)">{{ po.notes|default_if_none:'' }}</textarea>
                            </div>
                            <div class="po-form-group">
                                <label class="po-label-sm">Vendor Notes</label>
                                <textarea name="vendor_notes" class="po-textarea" rows="3" placeholder="Notes to include on PO sent to vendor">{{ po.vendor_notes|default_if_none:'' }}</textarea>
                            </div>
                            <div class="po-form-group">
                                <label class="po-label-sm">Receiving Notes</label>
                                <textarea name="receiving_notes" class="po-textarea" rows="3" placeholder="Notes about receiving/inspection">{{ po.receiving_notes|default_if_none:'' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attachments Card -->
                <div class="po-card">
                    <div class="po-card-header">
                        <div class="po-card-title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                            </svg>
                            Attachments
                            <span class="po-badge-count">{{ po.attachments.count }}</span>
                        </div>
                    </div>
                    <div class="po-card-body">
                        <form hx-post="{% url 'jobs:po_attachment_upload' po.pk %}"
                              hx-target="#attachments-list"
                              hx-swap="outerHTML"
                              hx-encoding="multipart/form-data"
                              class="po-upload-form">
                            {% csrf_token %}
                            <div class="po-upload-row">
                                <div class="po-file-input-wrapper">
                                    <input type="file" name="file" id="po-file-input" class="po-file-input" onchange="updateFileLabel(this)">
                                    <label for="po-file-input" class="po-file-label" id="po-file-label">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                            <polyline points="17 8 12 3 7 8"></polyline>
                                            <line x1="12" y1="3" x2="12" y2="15"></line>
                                        </svg>
                                        <span id="po-file-label-text">Choose file...</span>
                                    </label>
                                </div>
                                <input type="text" name="description" class="po-input" placeholder="Description (optional)">
                                <button type="submit" class="btn btn-sm btn-primary">Upload</button>
                            </div>
                        </form>
                        {% include 'jobs/partials/po_attachments_list.html' %}
                    </div>
                </div>
            </div>

            <!-- Sidebar Column -->
            <div class="po-sidebar">
                <!-- Status & Dates Card -->
                <div class="po-card">
                    <div class="po-card-header">
                        <div class="po-card-title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            Details
                        </div>
                    </div>
                    <div class="po-card-body">
                        <div class="po-form-group">
                            <label class="po-label-sm">Status</label>
                            <select name="status" id="po-status-select" class="po-select">
                                <option value="draft" {% if po.status == 'draft' %}selected{% endif %}>Draft</option>
                                <option value="submitted" {% if po.status == 'submitted' %}selected{% endif %}>Submitted</option>
                                <option value="partially_received" {% if po.status == 'partially_received' %}selected{% endif %}>Partially Received</option>
                                <option value="received" {% if po.status == 'received' %}selected{% endif %}>Received</option>
                                <option value="closed" {% if po.status == 'closed' %}selected{% endif %}>Closed</option>
                                <option value="cancelled" {% if po.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                            </select>
                        </div>
                        <div class="po-form-group">
                            <label class="po-label-sm">PO Date</label>
                            <input type="date" name="po_date" value="{{ po.po_date|date:'Y-m-d' }}" class="po-input" required>
                        </div>
                        <div class="po-form-group">
                            <label class="po-label-sm">Submitted Date</label>
                            <input type="date" name="submitted_date" value="{{ po.submitted_date|date:'Y-m-d' }}" class="po-input">
                        </div>
                        <div class="po-form-group">
                            <label class="po-label-sm">Expected Delivery</label>
                            <input type="date" name="expected_delivery_date" value="{{ po.expected_delivery_date|date:'Y-m-d' }}" class="po-input">
                        </div>
                        <div class="po-form-group">
                            <label class="po-label-sm">Actual Delivery</label>
                            <input type="date" name="actual_delivery_date" value="{{ po.actual_delivery_date|date:'Y-m-d' }}" class="po-input">
                        </div>
                        <div class="po-form-group">
                            <label class="po-label-sm">Requested By</label>
                            <select name="requested_by" class="po-select">
                                <option value="">Select user...</option>
                                {% for user in all_users %}
                                <option value="{{ user.id }}" {% if po.requested_by_id == user.id %}selected{% endif %}>
                                    {{ user.get_full_name|default:user.username }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Financial Card -->
                <div class="po-card po-financial-card">
                    <div class="po-card-header">
                        <div class="po-card-title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                            Financials
                        </div>
                    </div>
                    <div class="po-card-body">
                        <div class="po-financial-row">
                            <span class="po-financial-label">Subtotal</span>
                            <input type="number" name="subtotal" value="{{ po.subtotal|default_if_none:'' }}" class="po-input-money" step="0.01" readonly placeholder="0.00">
                        </div>
                        <div class="po-financial-row">
                            <span class="po-financial-label">Tax Rate (%)</span>
                            <input type="number" name="tax_rate" value="{{ po.tax_rate|default_if_none:'' }}" class="po-input-money" step="0.01" min="0" max="100" placeholder="0.00">
                        </div>
                        <div class="po-financial-row">
                            <span class="po-financial-label">Tax Amount</span>
                            <input type="number" name="tax_amount" value="{{ po.tax_amount|default_if_none:'' }}" class="po-input-money" step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="po-financial-row">
                            <span class="po-financial-label">Shipping</span>
                            <input type="number" name="shipping_cost" value="{{ po.shipping_cost|default_if_none:'' }}" class="po-input-money" step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="po-financial-row">
                            <span class="po-financial-label">Other Charges</span>
                            <input type="number" name="other_charges" value="{{ po.other_charges|default_if_none:'' }}" class="po-input-money" step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="po-financial-row">
                            <span class="po-financial-label">Discount</span>
                            <input type="number" name="discount_amount" value="{{ po.discount_amount|default_if_none:'' }}" class="po-input-money" step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="po-financial-total">
                            <span class="po-financial-label">Total</span>
                            <input type="number" name="total_amount" value="{{ po.total_amount|default_if_none:'' }}" class="po-input-total" step="0.01" readonly placeholder="0.00">
                        </div>
                    </div>
                </div>

                <!-- Shipping & Terms Card -->
                <div class="po-card">
                    <div class="po-card-header">
                        <div class="po-card-title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            Terms & Shipping
                        </div>
                    </div>
                    <div class="po-card-body">
                        <div class="po-form-group">
                            <label class="po-label-sm">Payment Terms</label>
                            <select name="payment_terms" class="po-select">
                                <option value="">Select terms...</option>
                                <option value="net_30" {% if po.payment_terms == 'net_30' %}selected{% endif %}>Net 30</option>
                                <option value="net_60" {% if po.payment_terms == 'net_60' %}selected{% endif %}>Net 60</option>
                                <option value="cod" {% if po.payment_terms == 'cod' %}selected{% endif %}>COD</option>
                                <option value="prepaid" {% if po.payment_terms == 'prepaid' %}selected{% endif %}>Prepaid</option>
                                <option value="other" {% if po.payment_terms == 'other' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                        <div class="po-form-group">
                            <label class="po-label-sm">Shipping Method</label>
                            <input type="text" name="shipping_method" value="{{ po.shipping_method|default_if_none:'' }}" class="po-input" placeholder="UPS Ground, FedEx...">
                        </div>
                        <div class="po-form-group">
                            <label class="po-label-sm">Shipping Account #</label>
                            <input type="text" name="shipping_account_number" value="{{ po.shipping_account_number|default_if_none:'' }}" class="po-input">
                        </div>
                        <div class="po-form-group">
                            <label class="po-label-sm">Tracking Number</label>
                            <input type="text" name="tracking_number" value="{{ po.tracking_number|default_if_none:'' }}" class="po-input">
                        </div>
                        <div class="po-form-group">
                            <label class="po-label-sm">Carrier</label>
                            <input type="text" name="carrier" value="{{ po.carrier|default_if_none:'' }}" class="po-input" placeholder="UPS, FedEx, USPS...">
                        </div>
                    </div>
                </div>

                <!-- Flags Card -->
                <div class="po-card">
                    <div class="po-card-header">
                        <div class="po-card-title">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                                <line x1="4" y1="22" x2="4" y2="15"></line>
                            </svg>
                            Flags
                        </div>
                    </div>
                    <div class="po-card-body">
                        <label class="po-checkbox-label">
                            <input type="checkbox" name="is_urgent" {% if po.is_urgent %}checked{% endif %} class="po-checkbox">
                            <span class="po-checkbox-text">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                    <line x1="12" y1="9" x2="12" y2="13"></line>
                                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                </svg>
                                Mark as Urgent
                            </span>
                        </label>
                        <label class="po-checkbox-label">
                            <input type="checkbox" name="is_drop_ship" {% if po.is_drop_ship %}checked{% endif %} class="po-checkbox">
                            <span class="po-checkbox-text">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="1" y="3" width="15" height="13"></rect>
                                    <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                                    <circle cx="5.5" cy="18.5" r="2.5"></circle>
                                    <circle cx="18.5" cy="18.5" r="2.5"></circle>
                                </svg>
                                Drop Ship Order
                            </span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Delete form (hidden) -->
    <form method="post" action="{% url 'jobs:po_delete' po.pk %}" id="delete-form" style="display: none;">
        {% csrf_token %}
    </form>
</div>

<style>
/* PO Page Layout */
.po-page {
    width: 100%;
    max-width: 1600px;
    margin: 0 auto;
    padding: 0 1rem;
}

/* Sticky Header */
.po-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 1rem 1.5rem;
    margin: -2rem -1rem 1.5rem -1rem;
    border-bottom: 1px solid var(--gray-200);
    position: sticky;
    top: 0;
    z-index: 50;
    box-shadow: var(--shadow-sm);
}

.po-header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.po-number-display {
    display: flex;
    flex-direction: column;
}

.po-number-display .po-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--gray-500);
    font-weight: 600;
}

.po-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--gray-900);
    margin: 0;
    line-height: 1.2;
}

.po-header-actions {
    display: flex;
    gap: 0.75rem;
}

.po-header-actions .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

/* Status Badge */
.po-status-badge {
    padding: 0.375rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.po-status-draft { background: var(--gray-100); color: var(--gray-700); }
.po-status-submitted { background: #dbeafe; color: #1e40af; }
.po-status-partially_received { background: #fef3c7; color: #92400e; }
.po-status-received { background: #d1fae5; color: #065f46; }
.po-status-closed { background: var(--gray-600); color: white; }
.po-status-cancelled { background: #fee2e2; color: #991b1b; }

.po-urgent-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.375rem 0.75rem;
    background: #fef3c7;
    color: #92400e;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
}

/* Two Column Layout */
.po-layout {
    display: grid;
    grid-template-columns: 1fr 340px;
    gap: 1.5rem;
    align-items: start;
}

.po-main {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

/* Two Column Row (Vendor + Ship To) */
.po-two-column-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.po-two-column-row .po-card {
    min-width: 0; /* Prevent overflow */
}

.po-sidebar {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    position: sticky;
    top: 90px;
}

/* Card Styles */
.po-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: 0.5rem;
    box-shadow: var(--shadow-sm);
    overflow: hidden;
}

.po-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.875rem 1.25rem;
    background: var(--gray-50);
    border-bottom: 1px solid var(--gray-200);
}

.po-card-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--gray-700);
}

.po-card-title svg {
    color: var(--gray-500);
}

.po-card-body {
    padding: 1.25rem;
}

.po-card-body.p-0 {
    padding: 0;
}

/* Ship To Address Buttons */
.po-ship-to-actions {
    display: flex;
    gap: 0.5rem;
}

.po-ship-to-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--gray-600);
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.15s ease;
}

.po-ship-to-btn:hover {
    background: var(--gray-50);
    border-color: var(--gray-400);
    color: var(--gray-700);
}

.po-ship-to-btn svg {
    color: var(--gray-500);
}

/* Form Elements */
.po-form-row {
    display: flex;
    gap: 1rem;
}

.po-form-row > .po-form-group {
    flex: 1;
}

.po-form-row-4 {
    grid-template-columns: repeat(4, 1fr);
}

.po-form-group {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
}

.po-form-group.full-width {
    grid-column: 1 / -1;
}

.po-form-group-2 {
    flex: 2;
}

.po-label-sm {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--gray-600);
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.po-input,
.po-select,
.po-textarea {
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--gray-300);
    border-radius: 0.375rem;
    font-size: 0.875rem;
    color: var(--gray-900);
    background: white;
    transition: all 0.15s ease;
}

.po-input:focus,
.po-select:focus,
.po-textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(74, 85, 104, 0.1);
}

.po-input::placeholder,
.po-textarea::placeholder {
    color: var(--gray-400);
}

.po-textarea {
    resize: vertical;
    min-height: 80px;
}

/* Financial Card */
.po-financial-card .po-card-body {
    padding: 1rem;
}

.po-financial-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--gray-100);
}

.po-financial-row:last-of-type {
    border-bottom: none;
}

.po-financial-label {
    font-size: 0.8125rem;
    color: var(--gray-600);
}

.po-input-money {
    width: 100px;
    padding: 0.375rem 0.5rem;
    border: 1px solid var(--gray-300);
    border-radius: 0.375rem;
    font-size: 0.875rem;
    text-align: right;
    color: var(--gray-900);
}

.po-input-money:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(74, 85, 104, 0.1);
}

.po-input-money[readonly] {
    background: var(--gray-50);
    color: var(--gray-600);
}

.po-financial-total {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0 0.25rem;
    margin-top: 0.5rem;
    border-top: 2px solid var(--gray-200);
}

.po-financial-total .po-financial-label {
    font-weight: 700;
    font-size: 0.875rem;
    color: var(--gray-900);
}

.po-input-total {
    width: 100px;
    padding: 0.375rem 0.5rem;
    border: 1px solid var(--gray-300);
    border-radius: 0.375rem;
    font-size: 1rem;
    font-weight: 700;
    text-align: right;
    background: var(--gray-50);
    color: var(--gray-900);
}

/* Checkbox Styles */
.po-checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    margin: -0.25rem -0.5rem;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: background 0.15s ease;
}

.po-checkbox-label:hover {
    background: var(--gray-50);
}

.po-checkbox {
    width: 18px;
    height: 18px;
    accent-color: var(--primary);
}

.po-checkbox-text {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--gray-700);
}

.po-checkbox-text svg {
    color: var(--gray-400);
}

/* Notes Grid */
.po-notes-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
}

/* Upload Form */
.po-upload-form {
    margin-bottom: 1rem;
}

.po-upload-row {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

.po-upload-row .po-input {
    flex: 1;
}

.po-file-input-wrapper {
    position: relative;
}

.po-file-input {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
}

.po-file-label {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.875rem;
    background: var(--gray-100);
    border: 1px dashed var(--gray-300);
    border-radius: 0.375rem;
    font-size: 0.875rem;
    color: var(--gray-600);
    cursor: pointer;
    transition: all 0.15s ease;
    white-space: nowrap;
}

.po-file-label:hover {
    background: var(--gray-200);
    border-color: var(--gray-400);
}

.po-file-label.has-file {
    background: #d1fae5;
    border-color: #a7f3d0;
    border-style: solid;
    color: #065f46;
}

/* Badge Count */
.po-badge-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 20px;
    height: 20px;
    padding: 0 0.375rem;
    background: var(--gray-200);
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--gray-600);
}

/* Button Variants */
.btn-outline {
    background: white;
    color: var(--gray-700);
    border: 1px solid var(--gray-300);
}

.btn-outline:hover {
    background: var(--gray-50);
    border-color: var(--gray-400);
}

.btn-danger-outline {
    background: white;
    color: var(--error);
    border: 1px solid var(--gray-300);
}

.btn-danger-outline:hover {
    background: #fef2f2;
    border-color: var(--error);
}

/* Utility Classes */
.mt-lg {
    margin-top: 1rem;
}

.mb-sm {
    margin-bottom: 0.75rem;
}

/* 2x2 Grid for compact form rows */
.po-form-row-2x2 {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
}

/* Responsive */
@media (max-width: 1280px) {
    .po-layout {
        grid-template-columns: 1fr;
    }
    
    .po-sidebar {
        position: static;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
    }
    
    .po-notes-grid {
        grid-template-columns: 1fr;
    }
    
    .po-form-row-4 {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 900px) {
    .po-sidebar {
        grid-template-columns: 1fr;
    }
    
    .po-two-column-row {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 640px) {
    .po-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .po-header-left {
        flex-wrap: wrap;
    }
    
    .po-header-actions {
        flex-wrap: wrap;
    }
    
    .po-form-row,
    .po-form-row-4,
    .po-form-row-2x2 {
        grid-template-columns: 1fr;
    }
    
    .po-upload-row {
        flex-direction: column;
        align-items: stretch;
    }
}
</style>

<script>
// Update file input label with selected filename
function updateFileLabel(input) {
    const labelText = document.getElementById('po-file-label-text');
    if (input.files && input.files.length > 0) {
        labelText.textContent = input.files[0].name;
        document.getElementById('po-file-label').classList.add('has-file');
    } else {
        labelText.textContent = 'Choose file...';
        document.getElementById('po-file-label').classList.remove('has-file');
    }
}

// Use default address from settings
function useDefaultAddress() {
    fetch('{% url "jobs:po_get_default_address" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('ship_to_name').value = data.name || '';
                document.getElementById('ship_to_address').value = data.address || '';
                document.getElementById('ship_to_city').value = data.city || '';
                document.getElementById('ship_to_state').value = data.state || '';
                document.getElementById('ship_to_zip').value = data.zip || '';
                document.getElementById('ship_to_phone').value = data.phone || '';
            } else {
                alert('No default address configured. Please set it in Settings > System Configuration.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading default address');
        });
}

// Fill ship-to address from customer data
function fillShipToAddress(name, address, city, state, zip, phone) {
    document.getElementById('ship_to_name').value = name || '';
    document.getElementById('ship_to_address').value = address || '';
    document.getElementById('ship_to_city').value = city || '';
    document.getElementById('ship_to_state').value = state || '';
    document.getElementById('ship_to_zip').value = zip || '';
    document.getElementById('ship_to_phone').value = phone || '';
    
    // Close the modal
    const modal = document.getElementById('po-customer-search-modal');
    if (modal) {
        modal.remove();
    }
}

// Update status badge when dropdown changes
function updateStatusBadge() {
    const select = document.getElementById('po-status-select');
    const badge = document.getElementById('po-status-badge');
    if (select && badge) {
        const status = select.value;
        const displayText = select.options[select.selectedIndex].text;
        
        // Remove all status classes and add the new one
        badge.className = 'po-status-badge po-status-' + status;
        badge.textContent = displayText;
    }
}

// Attach event listener to status dropdown
document.addEventListener('DOMContentLoaded', function() {
    const statusSelect = document.getElementById('po-status-select');
    if (statusSelect) {
        statusSelect.addEventListener('change', updateStatusBadge);
    }
});

// Re-attach after HTMX swaps (in case dropdown is replaced via OOB)
document.body.addEventListener('htmx:afterSwap', function(event) {
    const statusSelect = document.getElementById('po-status-select');
    if (statusSelect) {
        statusSelect.removeEventListener('change', updateStatusBadge);
        statusSelect.addEventListener('change', updateStatusBadge);
    }
});
</script>
{% endblock %}


